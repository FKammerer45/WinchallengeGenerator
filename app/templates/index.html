{% extends "base.html" %}
{% block title %}Home - Win Challenge Generator{% endblock %}

{% block content %}
<div class="container mt-4">
  <h1 class="mb-4 text-center">Win Challenge Generator</h1>
  <p class="text-center text-muted mb-4">Configure parameters and generate your next gaming challenge!</p>

  <form id="challengeForm" method="post" action="{{ url_for('challenge_api.generate_challenge') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <fieldset class="form-group border rounded p-3 mb-4 shadow-sm">
        <legend class="w-auto px-2 h5 font-weight-bold">1. Data Sources</legend>
        <div class="form-row">
            <div class="form-group col-md-6">
              <label for="gameSourceSelect">Game Entries Source Tab:</label>
              <select id="gameSourceSelect" name="game_tab_id" class="form-control custom-select">
                </select>
              <small class="form-text text-muted">Select the tab containing the game wins to use.</small>
            </div>
            <div class="form-group col-md-6">
                <label for="penaltySourceSelect">Penalty Source Tab:</label>
                <select id="penaltySourceSelect" name="penalty_tab_id" class="form-control custom-select">
                  </select>
                 <small class="form-text text-muted">Select the tab containing the penalties to use (if enabled).</small>
            </div>
        </div>
         <div class="form-group form-check mt-2">
            <input type="checkbox" class="form-check-input" id="usePenaltiesCheckbox" name="use_penalties">
            <label class="form-check-label" for="usePenaltiesCheckbox">Enable Penalties on Game Loss?</label>
        </div>
    </fieldset>

    <fieldset class="form-group border rounded p-3 mb-4 shadow-sm">
        <legend class="w-auto px-2 h5 font-weight-bold">2. Players & Parameters</legend>
        <div class="form-row">
             <div class="form-group col-md-6 col-lg-3">
                <label for="numPlayers" class="font-weight-bold">Number of Players:</label>
                <select id="numPlayers" name="num_players" class="form-control custom-select">
                    <option value="1" selected>1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
            </div>
            <div class="form-group col-md-6 col-lg-3">
                <label for="desiredDiff" class="font-weight-bold">Target Difficulty:</label>
                <input type="number" step="0.1" id="desiredDiff" name="desired_diff" class="form-control"
                       placeholder="e.g., 60.0" required value="60">
            </div>
             <div class="form-group col-md-12 col-lg-6">
                <label for="spinB2B" class="font-weight-bold">
                  Back-to-Back Probability: <small class="text-muted">(0=none, 10=high)</small>
                </label>
                <input type="range" id="spinB2B" name="raw_b2b" class="custom-range"
                       min="0" max="10" step="1" value="1"
                       oninput="this.nextElementSibling.value = this.value">
                <output class="badge badge-secondary ml-2">1</output> </div>
        </div><div id="playerNamesContainer" class="mt-3" style="display: none;">
             </div>
    </fieldset>


    <fieldset class="form-group border rounded p-3 mb-4 shadow-sm">
        <legend class="w-auto px-2 h5 font-weight-bold">3. Select Games & Modes</legend>
        <div class="p-0 table-responsive"> <table class="table table-dark table-striped table-hover table-sm mb-0"> <thead>
                <tr>
                  <th style="width:45%;">Game</th>
                  <th style="width:15%;">Weight</th>
                  <th style="width:40%;">Allowed Modes</th>
                </tr>
              </thead>
              <tbody id="gamesSelectionTbody">
                <tr><td colspan="3" class="text-center text-muted py-4">Select Game Source Tab above to load games...</td></tr>
              </tbody>
            </table>
        </div>
        <small class="form-text text-muted mt-2">Check games to include. Click 'Select Modes' to filter specific game modes if needed.</small>
    </fieldset>

    <button type="submit" class="btn btn-primary btn-lg btn-block mt-4 mb-4">Generate Challenge</button>
  </form>

  <hr>
  <h2 class="text-center mb-3">Generated Challenge</h2>
  <div id="challengeResultWrapper" class="mb-5"> <div id="challengeResult" class="card p-3 mb-3" style="display:none; background-color: #282c34; color: #eee; border: 1px solid #555;">
          <p class="text-center text-muted">Loading result...</p>
      </div>
      <div class="text-center"> <button id="acceptBtn" class="btn btn-success mt-2" style="display:none;">Accept Challenge & View</button>
      </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
  window.generateChallengeUrl = "{{ url_for('challenge_api.generate_challenge') }}";
  window.acceptChallengeUrl = "{{ url_for('main.accept_challenge') }}";
  window.viewChallengesUrl = "{{ url_for('main.challenge_view') }}";
  console.log("[index.html] URLs set for JS.");
</script>
<script type="module" src="{{ url_for('static', filename='js/games/localStorageUtils.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/penalties/penaltyLocalStorageUtils.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/challenge/challenge.js') }}"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => { /* ... Accept button listener ... */
     const acceptBtn = document.getElementById("acceptBtn"); if (acceptBtn) { acceptBtn.addEventListener("click", () => { if (!window.currentChallengeData) { alert("No challenge generated."); return; } const csrfTokenInput = document.querySelector('#challengeForm input[name="csrf_token"]'); if (!csrfTokenInput) { alert("Security token not found."); return; } fetch(window.acceptChallengeUrl, { method: "POST", headers: { "Content-Type": "application/json", "X-CSRFToken": csrfTokenInput.value }, body: JSON.stringify(window.currentChallengeData) }) .then(res => { if (!res.ok) { return res.json().catch(()=>({})).then(err => {throw new Error(err.error || `HTTP ${res.status}`)}) } return res.json(); }) .then(resData => { if (resData.status === "ok") { window.location.href = window.viewChallengesUrl; } else { alert("Error accepting challenge: " + (resData.error || "Unknown")); } }) .catch(err => { console.error("Accept Error:", err); alert("Error accepting challenge: " + err.message); }); }); } });
</script>
{% endblock %}