{% extends "base.html" %}
{% block title %}Home - Win Challenge Generator{% endblock %}

{% block content %}
<div class="container mt-4">
  <h1 class="mb-4 text-center">Win Challenge Generator</h1>
  <p class="text-center text-muted mb-4">Configure parameters and generate your next gaming challenge!</p>

  <form id="challengeForm" method="post" action="{{ url_for('challenge_api.generate_challenge') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    {# --- FIELDSET 1: Data Sources & Challenge Options --- #}
    <fieldset class="form-group border rounded p-3 mb-4 shadow-sm">
        <legend class="w-auto px-2 h5 font-weight-bold">1. Source & Options</legend>

        {# Game Source #}
        <div class="form-row">
            <div class="form-group col-md-6">
              <label for="gameSourceSelect">Game Entries Source Tab:</label>
              <select id="gameSourceSelect" name="game_tab_id" class="form-control custom-select">
                {# Options populated by JS #}
              </select>
              <small class="form-text text-muted">Select the tab containing the games.</small>
            </div>

            {# --- MODIFIED: Penalty Source (Conditional Container) --- #}
            <div class="form-group col-md-6 {% if not request.form.get('use_penalties') %}d-none{% endif %}" id="penaltySourceContainer">
                <label for="penaltySourceSelect">Penalty Source Tab:</label>
                <select id="penaltySourceSelect" name="penalty_tab_id" class="form-control custom-select">
                  {# Options populated by JS #}
                </select>
               <small class="form-text text-muted">Select the tab containing the penalties.</small>
           </div>
           {# --- END MODIFICATION --- #}
        </div>

        {# Enable Penalties Checkbox #}
        <div class="form-group form-check mt-2">
            <input type="checkbox" class="form-check-input" id="enablePenalties" name="use_penalties" {% if request.form.get('use_penalties') %}checked{% endif %}>
            <label class="form-check-label" for="enablePenalties">Enable Penalties on Game Loss?</label>
        </div>

        {# Challenge Name (Optional) #}
        <div class="form-row mt-3">
            <div class="form-group col-md-12">
                <label for="challengeName">Challenge Name (Optional):</label>
                <input type="text" id="challengeName" name="challenge_name" class="form-control" placeholder="My Awesome Challenge" value="{{ request.form.get('challenge_name', '') }}">
                <small class="form-text text-muted">Give your challenge a name (used when sharing).</small>
            </div>
        </div>
    </fieldset>

    {# --- FIELDSET 2: Mode, Players & Parameters --- #}
    <fieldset class="form-group border rounded p-3 mb-4 shadow-sm">
        <legend class="w-auto px-2 h5 font-weight-bold">2. Mode & Parameters</legend>

        {# --- ADDED: Mode Selection --- #}
        <div class="form-group row mb-3">
            <label class="col-sm-4 col-lg-3 col-form-label font-weight-bold">Challenge Mode:</label>
            <div class="col-sm-8 col-lg-9">
                <div class="form-check form-check-inline">
                    <input class="form-check-input mode-radio" type="radio" name="group_mode" id="modeSingleGroup" value="single" {% if request.form.get('group_mode', 'single') == 'single' %}checked{% endif %}>
                    <label class="form-check-label" for="modeSingleGroup">Single Group (Local)</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input mode-radio" type="radio" name="group_mode" id="modeMultiGroup" value="multi" {% if request.form.get('group_mode') == 'multi' %}checked{% endif %}>
                    <label class="form-check-label" for="modeMultiGroup">Multigroup (Shared)</label>
                    <small class="text-warning login-required-msg ms-2 d-none">(Login required)</small>
                </div>
                <small class="form-text text-muted d-block">Single group saves locally. Multigroup requires login to share.</small>
            </div>
        </div>
        {# --- END Mode Selection --- #}

        {# --- Number of Players (Label changes) & Conditional Max Groups --- #}
        <div class="form-row">
            <div class="form-group col-md-6 col-lg-4">
                <label for="numPlayers" class="font-weight-bold" id="numPlayersLabel">Number of Players:</label>
                <select id="numPlayers" name="num_players" class="form-control custom-select">
                    <option value="1" {% if request.form.get('num_players', '1') == '1' %}selected{% endif %}>1</option>
                    <option value="2" {% if request.form.get('num_players') == '2' %}selected{% endif %}>2</option>
                    <option value="3" {% if request.form.get('num_players') == '3' %}selected{% endif %}>3</option>
                    <option value="4" {% if request.form.get('num_players') == '4' %}selected{% endif %}>4</option>
                    <option value="5" {% if request.form.get('num_players') == '5' %}selected{% endif %}>5</option>
                </select>
                <small class="form-text text-muted">Relevant for difficulty scaling.</small>
            </div>

            <div class="form-group col-md-6 col-lg-4 {% if request.form.get('group_mode', 'single') != 'multi' %}d-none{% endif %}" id="maxGroupsContainer">
                <label for="maxGroups">Max Groups (Multigroup):</label>
                <input type="number" id="maxGroups" name="max_groups" class="form-control" value="{{ request.form.get('max_groups', 10) }}" min="1">
                <small class="form-text text-muted">Max groups allowed when shared.</small>
            </div>
        </div>

        {# --- REMOVED Player Names Container --- #}

        {# --- Difficulty & B2B --- #}
        <div class="form-row mt-3">
             <div class="form-group col-md-6 col-lg-4">
                 <label for="desiredDiff" class="font-weight-bold">Target Difficulty:</label>
                 <input type="number" step="0.1" id="desiredDiff" name="desired_diff" class="form-control" placeholder="e.g., 60.0" required value="{{ request.form.get('desired_diff', 60) }}">
             </div>
             <div class="form-group col-md-12 col-lg-8">
                 <label for="spinB2B" class="font-weight-bold">
                   Back-to-Back Probability: <small class="text-muted">(0=none, 10=high)</small>
                 </label>
                 <input type="range" id="spinB2B" name="raw_b2b" class="custom-range" min="0" max="10" step="1" value="{{ request.form.get('raw_b2b', 1) }}" oninput="this.nextElementSibling.value = this.value">
                 <output class="badge badge-secondary ml-2">{{ request.form.get('raw_b2b', 1) }}</output>
             </div>
         </div>
    </fieldset>

    {# --- FIELDSET 3: Select Games & Modes --- #}
    <fieldset class="form-group border rounded p-3 mb-4 shadow-sm">
        <legend class="w-auto px-2 h5 font-weight-bold">3. Select Games & Modes</legend>
        {# --- ADDED BACK TABLE STRUCTURE --- #}
        <div class="p-0 table-responsive">
             <table class="table table-dark table-striped table-hover table-sm mb-0">
                <thead>
                    <tr>
                        <th style="width:45%;">Game</th>
                        <th style="width:15%;">Weight</th>
                        <th style="width:40%;">Allowed Modes</th>
                    </tr>
                </thead>
                <tbody id="gamesSelectionTbody"> {# Ensure this ID exists #}
                    {# Initial placeholder, JS will replace this #}
                    <tr><td colspan="3" class="text-center text-muted py-4">Select Game Source Tab above...</td></tr>
                </tbody>
             </table>
        </div>
        <small class="form-text text-muted mt-2">Check games to include. Adjust weights. Click 'Modes' to filter.</small>
         {# --- END ADDED BACK TABLE STRUCTURE --- #}
    </fieldset>

    <button type="submit" class="btn btn-primary btn-lg btn-block mt-4 mb-4">Generate Challenge</button>
  </form>

  <hr>
  <h2 class="text-center mb-3">Generated Challenge</h2>
  <div id="challengeResultWrapper" class="mb-5">
      <div id="challengeResult" class="card p-3 mb-3" style="display:none; background-color: #282c34; color: #eee; border: 1px solid #555;">
        <p class="text-center text-muted">Loading result...</p>
      </div>
      <div class="text-center">
          {# Share button shown only if logged in #}
          {% if current_user.is_authenticated %}
            <button id="shareChallengeBtn" class="btn btn-info mt-2" style="display:none;">Share Challenge</button>
          {% endif %}
          {# View Local button shown only if NOT logged in (handled by JS) #}
          <a href="#" id="viewLocalChallengeBtn" class="btn btn-secondary mt-2" style="display:none;" role="button" target="_blank">View Locally Saved Challenge</a>
      </div>
      <div id="shareResult" class="mt-3" style="display:none;">
          {# Share link appears here via JS #}
      </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
{# Pass data needed by JS #}
<script>
  window.csrfToken = "{{ csrf_token() }}";
  window.generateChallengeUrl = "{{ url_for('challenge_api.generate_challenge') }}";
  window.shareChallengeUrl = "{{ url_for('challenge_api.share_challenge') }}";
  window.IS_AUTHENTICATED = {{ current_user.is_authenticated | lower }}; // Pass boolean
  // Assume view_local_challenge_viewer is the endpoint for the local viewer page
  window.viewLocalChallengeBaseUrl = "{{ url_for('main.view_local_challenge_viewer', _external=False) }}";

  console.log("[index.html] URLs, CSRF Token, Auth Status set for JS.");
</script>
{# Load main JS module entry point #}
<script type="module" src="{{ url_for('static', filename='js/challenge/challenge.js') }}"></script>

{% endblock %}