{% extends "base.html" %}
{% block title %}Home - Win Challenge Generator{% endblock %}

{% block head %}
{{ super() }}
{# Base style.css is linked in base.html #}
{% endblock %}

{% block content %}
{# --- Larry Easter Egg Elements --- #}
<div id="larryOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0,0,0,0); z-index: 10000; opacity: 0; transition: background-color 1s ease-in-out, opacity 1s ease-in-out;">
    <img id="larryImage" src="{{ url_for('static', filename='images/larry.png') }}" alt="Larry!" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.5); max-width: 90%; max-height: 90%; opacity: 0; transition: opacity 1.5s ease-in-out 0.5s, transform 1.5s ease-in-out 0.5s; z-index: 10001;">
</div>
<audio id="larrySound" src="{{ url_for('static', filename='sounds/larry.mp3') }}" preload="auto"></audio>
{# --- End Larry Easter Egg Elements --- #}

<div class="container mt-4 index-page-container">
    {# --- Enhanced Page Header --- #}
    <div class="text-center mb-5 pt-4">
        <h1 class="display-4 page-title mb-3 fw-light">
            <i class="bi bi-trophy-fill me-2 text-primary-accent"></i>
            Win Challenge Generator
        </h1>
        <p class="lead text-secondary col-lg-9 mx-auto">
            Configure your preferences, select games, and generate unique gaming challenges!
        </p>
    </div>

    {# Form wraps ALL input sections AND the generate button #}
    <form id="challengeForm" method="post" action="{{ url_for('challenge_api.generate_challenge') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        {# --- Row 1: Options | Mode & Parameters --- #}
        <div class="row g-4 match-height"> {# Row 1 has consistent spacing #}
            {# Col 1.1 Options #}
            <div class="col-lg-6">
                <div class="card shadow-sm glass-effect h-100">
                    <div class="card-header h5 d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-sliders me-2"></i>Options</span>
                        <button class="btn btn-sm btn-outline-secondary py-0 px-1" type="button" data-toggle="collapse"
                            data-target="#optionsBody" aria-expanded="true" aria-controls="optionsBody"
                            title="Toggle Options Section">
                            <i class="bi bi-chevron-expand"></i>
                        </button>
                    </div>
                    <div class="collapse show card-body" id="optionsBody">
                        {# Penalties #}
                        <div class="d-flex align-items-center flex-wrap mb-3">
                            <div class="custom-control custom-checkbox me-3 mb-2 mb-sm-0">
                                <input type="checkbox" class="custom-control-input" id="enablePenalties"
                                    name="use_penalties" {% if request.form.get('use_penalties') %}checked{% endif %}>
                                <label class="custom-control-label fw-bold" for="enablePenalties">Enable
                                    Penalties?</label>
                            </div>
                            <div id="penaltySourceContainer" class="d-none flex-grow-1" style="min-width: 180px;">
                                <select id="penaltySourceSelect" name="penalty_tab_id"
                                    class="form-control form-control-sm custom-select" aria-label="Penalty Source Tab">
                                    <option value="" disabled selected>Loading penalty tabs...</option>
                                </select>
                            </div>
                        </div>
                        {# Challenge Name #}
                        <div class="form-group mb-0">
                            <label for="challengeName" class="fw-bold">Challenge Name <small>(Optional)</small></label>
                            <input type="text" id="challengeName" name="challenge_name"
                                class="form-control form-control-sm" placeholder="e.g., Weekend Grind"
                                value="{{ request.form.get('challenge_name', '') }}">
                            <small class="form-text text-secondary mt-1">Title of the challenge.</small>
                        </div>

                        {# Challenge Limits Display - Added Here #}
                        {% if current_user.is_authenticated %}
                        <hr class="my-3">
                        <div class="form-group mb-0">
                            <label class="fw-bold">Challenge Quota:</label>
                            <p class="mb-1">
                                Created: <strong>{{ challenge_count }} / {{ max_challenges }}</strong>
                                {% if not user_is_pro and challenge_count >= max_challenges %}
                                    <span class="badge bg-danger-subtle text-danger-emphasis ms-2">Limit Reached</span>
                                {% elif not user_is_pro and challenge_count >= max_challenges * 0.8 %}
                                    <span class="badge bg-warning-subtle text-warning-emphasis ms-2">Nearing Limit</span>
                                {% endif %}
                            </p>
                            {% if not user_is_pro and challenge_count >= max_challenges %}
                                <small class="form-text text-secondary">
                                    <a href="{{ url_for('main.subscribe') }}">Upgrade to Pro</a> for more challenges.
                                </small>
                            {% elif not user_is_pro %}
                                <small class="form-text text-secondary">
                                    Pro members can create up to {{ PLAN_LIMITS.pro.max_challenges }} challenges. <a href="{{ url_for('main.subscribe') }}">Learn More</a>.
                                </small>
                            {% endif %}
                        </div>
                        {% endif %}
                        {# End Challenge Limits Display #}

                    </div>
                </div>
            </div>{# End Col 1.1 #}

            {# Col 1.2 Mode & Parameters #}
            <div class="col-lg-6">
                <div class="card shadow-sm glass-effect h-100">
                    <div class="card-header h5 d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-diagram-3 me-2"></i>Mode & Parameters</span>
                        <button class="btn btn-sm btn-outline-secondary py-0 px-1" type="button" data-toggle="collapse"
                            data-target="#modeParamsBody" aria-expanded="true" aria-controls="modeParamsBody"
                            title="Toggle Mode & Parameters Section">
                            <i class="bi bi-chevron-expand"></i>
                        </button>
                    </div>
                    <div class="collapse show card-body" id="modeParamsBody">
                        {# Challenge Mode Radio Buttons #}
                        <div class="form-group mb-3">
                            <label class="fw-bold d-block mb-2">Challenge Mode:</label>
                            <div class="d-flex flex-wrap">
                                <div class="custom-control custom-radio me-3 mb-1">
                                    <input class="custom-control-input mode-radio" type="radio" name="group_mode"
                                        id="modeSingleGroup" value="single" {% if
                                        request.form.get('group_mode', 'single' )=='single' %}checked{% endif %}>
                                    <label class="custom-control-label" for="modeSingleGroup">Single Group
                                    </label>
                                </div>
                                <div class="custom-control custom-radio me-3 mb-1">
                                    <input class="custom-control-input mode-radio" type="radio" name="group_mode"
                                        id="modeMultiGroup" value="multi" {% if request.form.get('group_mode')=='multi'
                                        %}checked{% endif %}>
                                    <label class="custom-control-label" for="modeMultiGroup">Multigroup </label>
                                </div>
                            </div>
                            <small class="text-warning login-required-msg mt-1 d-none">(Login required for
                                Multigroup)</small>
                            
                        </div>
                        {# Player/Group Size Inputs #}
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="numPlayers" class="fw-bold" id="numPlayersLabel">Number of Players:</label>
                                <select id="numPlayers" name="num_players"
                                    class="form-control form-control-sm custom-select">
                                    {% for i in range(1, 6) %}
                                    <option value="{{ i }}" {% if request.form.get('num_players', '1' )|int==i
                                        %}selected{% endif %}>{{ i }}</option>
                                    {% endfor %}
                                </select>
                                
                            </div>
                            <div class="col-md-6 d-none" id="maxGroupsContainer">
                                <label for="maxGroups" class="fw-bold">Max Groups:</label>
                                <input type="number" id="maxGroups" name="max_groups"
                                    class="form-control form-control-sm"
                                    value="{{ request.form.get('max_groups', 10) }}" min="1" max="20">
                                <small class="form-text text-secondary mt-1">Max groups for shared challenges.</small>
                            </div>
                        </div>
                        {# Difficulty and B2B Sliders #}
                        <div class="row g-3">
                            <div class="col-md-6">

                                <label for="desiredDiff" class="fw-bold">
                                    Target Difficulty

                                </label>
                                {# Tooltip attributes moved to the input element #}
                                <input type="number" step="0.1" id="desiredDiff" name="desired_diff"
                                    class="form-control form-control-sm" placeholder="e.g., 60.0" max="1500" min="0.2"
                                    required value="{{ request.form.get('desired_diff', 60) }}" data-toggle="tooltip"
                                    data-placement="top"
                                    title="Controls overall challenge length/difficulty. Higher values mean more wins required.">
                                {# Shortened visible help text remains #}
                                <small class="form-text text-secondary mt-1">
                                    (Guideline: 10 ≈ 1 hour playtime)
                                </small>

                            </div>
                            <div class="col-md-6">

                                <label for="spinB2B" class="fw-bold d-block mb-1" data-toggle="tooltip"
                                    data-placement="top"
                                    title="Higher values increase the chance of getting Back-to-Back (B2B) segments. At 100%, all generated segments will be B2B (2-4 wins).">
                                    B2B Probability:
                                    {# Give output an ID and remove inline update/content #}
                                    <output class="range-value-display" id="b2bValueDisplay"></output>
                                    <i class="bi bi-info-circle-fill text-secondary small ms-1 align-middle"></i>
                                </label>
                                <input type="range" id="spinB2B" name="raw_b2b" class="custom-range align-middle"
                                    min="0" max="10" step="1" value="{{ request.form.get('raw_b2b', 1) }}">
                                {# Updated track labels #}
                                <div class="d-flex justify-content-between w-100 px-1 small text-secondary">
                                    <span>0%</span>
                                    <span>100%</span>
                                </div>
                                {# Added help text #}
                                <small class="form-text text-secondary mt-1">
                                    Increases chance of multiple wins needed in sequence.
                                </small>

                            </div>
                        </div>
                    </div>
                </div>
            </div> {# End Col 1.2 #}
        </div> {# End Row 1 #}

        {# --- Row 2: Game Selection | Generate & Result Column --- #}
        <div class="row g-4 match-height"> {# Row 2 needs spacing too #}
            {# Col 2.1 Game Selection #}
            <div class="col-lg-6">
                <div class="card shadow-sm glass-effect h-100">
                    <div class="card-header h5 d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-joystick me-2"></i>Select Games & Modes</span>
                        <button class="btn btn-sm btn-outline-secondary py-0 px-1" type="button" data-toggle="collapse"
                            data-target="#gamesModesBody" aria-expanded="true" aria-controls="gamesModesBody"
                            title="Toggle Games & Modes Section">
                            <i class="bi bi-chevron-expand"></i>
                        </button>
                    </div>
                    <div class="collapse show card-body" id="gamesModesBody">
                        {# Game Source Dropdown #}
                        <div class="form-group mb-3">
                            <label for="gameSourceSelect" class="fw-bold">Game Entries Source:</label>
                            <select id="gameSourceSelect" name="game_tab_id"
                                class="form-control form-control-sm custom-select">
                                <option value="" disabled selected>Loading tabs...</option>
                                {# JS Populates this #}
                            </select>
                            <small class="form-text text-secondary mt-1">Choose the list of games to use for
                                generation.</small>
                        </div>
                        {# Select/Deselect Buttons #}
                        <div class="d-flex justify-content-end mb-3">
                            <div class="btn-group">
                                <button type="button" id="selectAllGamesBtn"
                                    class="btn btn-sm btn-outline-primary">Select All</button>
                                <button type="button" id="deselectAllGamesBtn"
                                    class="btn btn-sm btn-outline-secondary">Deselect All</button>
                            </div>
                        </div>
                        {# Game Selection Table Wrapper #}
                        <div class="table-responsive game-selection-table-wrapper border rounded">
                            <table class="table table-hover table-sm mb-0 game-selection-table">
                                <thead>
                                    <tr>
                                        <th style="width:50%;">Game</th>
                                        <th style="width:15%;">Weight</th>
                                        <th style="width:35%;">Allowed Modes</th>
                                    </tr>
                                </thead>
                                <tbody id="gamesSelectionTbody">
                                    <tr>
                                        <td colspan="3" class="text-center text-secondary py-4">Select Game Source Tab
                                            above...</td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr id="showMoreGamesRow" class="d-none">
                                        <td colspan="3" class="text-center py-2">
                                            <button type="button" id="showLessGamesBtn"
                                                class="btn btn-outline-secondary btn-sm me-2 d-none">▲ Show
                                                less</button>
                                            <button type="button" id="showMoreGamesBtn"
                                                class="btn btn-outline-primary btn-sm">▼ Show more</button>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div> {# End Card Body #}
                </div>
            </div> {# End Col 2.1 #}

            {# Col 2.2 Generate Button & Result Area #}
            <div class="col-lg-6">
                {# Container with flex layout for button and results area #}
                <div class="result-column-content">

                    {# --- Generate Button Container (INSIDE FORM) --- #}
                    <div class="generate-button-container text-center mb-3">
                        <div class="btn-group w-100" role="group" aria-label="Challenge Actions">
                            <button type="submit"
                                class="btn btn-warning btn-lg shadow-lg generate-btn d-inline-flex align-items-center justify-content-center flex-fill">
                                <span class="spinner-border spinner-border-sm me-2" style="display: none;"></span>
                                <i class="bi bi-magic me-2"></i>
                                <span>Generate Challenge</span>
                            </button>
                            <button type="button" id="showCustomChallengeBuilderBtn"
                                class="btn btn-info btn-lg shadow-lg d-inline-flex align-items-center justify-content-center flex-fill">
                                <i class="bi bi-tools me-2"></i>
                                <span>Build Custom Challenge</span>
                            </button>
                        </div>
                        <div id="formErrorDisplay" class="alert alert-danger mt-3" style="display: none;"></div>
                    </div>
                    {# --- End Generate Button Container --- #}

                    {# --- Custom Challenge Builder Wrapper (Placeholder) --- #}
                    <div id="customChallengeBuilderWrapper" class="mt-4" style="display:none;">
                        <hr class="my-4" style="border-color: var(--surface-border);">
                        <div class="result-card glass-effect p-4"> {# Re-use result-card for similar base styling #}
                            <h3 class="mb-3 text-center h4">Custom Challenge Builder</h3>
                            
                            {# Group Type & Difficulty Display - Styled like result header #}
                            <p class="text-center mb-4">
                                <strong>Mode:</strong> <span id="customChallengeGroupTypeDisplay">Single Group</span> | 
                                <strong>Total Difficulty:</strong> <span id="customChallengeTotalDifficultyDisplay">0</span>
                            </p>

                            {# Normal Wins Section #}
                            <div class="custom-builder-section mb-4">
                                <h4 class="custom-builder-section-header">Normal Wins</h4>
                                <div id="normalWinsContainer" class="custom-builder-item-list">
                                    {# Game rows will be added here by JS, styled like result items #}
                                </div>
                                <button type="button" id="addNormalWinGameBtn" class="btn btn-sm btn-success mt-2 w-100">
                                    <i class="bi bi-plus-lg"></i> Add Game to Normal Wins
                                </button>
                            </div>

                            {# Back-to-Back Segments Section #}
                            <div class="custom-builder-section">
                                <h4 class="custom-builder-section-header">Back-to-Back Segments</h4>
                                <div id="b2bSegmentsContainer" class="custom-builder-item-list">
                                    {# B2B Segments will be added here by JS #}
                                </div>
                                <button type="button" id="addB2bSegmentBtn" class="btn btn-sm btn-info mt-2 w-100">
                                    <i class="bi bi-plus-square-dotted"></i> Add B2B Segment
                                </button>
                            </div>
                            
                            <hr class="my-4">
                            <div class="text-center">
                                <button type="button" id="createCustomChallengeBtn" class="btn btn-primary btn-lg w-100">
                                    <i class="bi bi-plus-circle-fill"></i> Create Challenge
                                </button>
                            </div>
                        </div>
                    </div>
                    {# --- End Custom Challenge Builder Wrapper --- #}

                    {# --- Result Wrapper (Placeholder, OUTSIDE form logic but inside layout column) --- #}
                    {# This outer div is targeted by JS to be shown/hidden #}
                    <div id="challengeResultWrapper" style="display:none;">
                        <hr class="my-4" style="border-color: var(--surface-border);">
                        <h3 class="mb-3 text-light text-center h4">Generated Challenge</h3>
                        {# Inner div where HTML result content is injected #}
                        <div id="challengeResult" class="p-4 mb-3 shadow-lg result-card glass-effect">
                            <p class="text-center text-secondary">Waiting for generation...</p>
                        </div>
                        {# Action buttons shown after generation #}
                        <div class="result-actions text-center mt-3 d-flex justify-content-center flex-wrap gap-2">
                            {% if current_user.is_authenticated %}
                            <button id="shareChallengeBtn" class="btn btn-primary btn-lg action-btn"
                                style="display:none;">
                                <span class="spinner-border spinner-border-sm" style="display: none;"></span>
                                <i class="bi bi-check-circle-fill me-1"></i> {# Changed icon to suit "Accept" #}
                                <span>Accept Challenge</span>
                            </button>
                            {% endif %}
                            <a href="#" id="viewLocalChallengeBtn" class="btn btn-secondary btn-lg action-btn"
                                style="display:none;" role="button" target="_blank">
                                <i class="bi bi-eye-fill me-1"></i>
                                View Locally Saved Challenge
                            </a>
                        </div>
                        {# Div for displaying share success/error #}
                        <div id="shareResult" class="mt-3 share-result-display text-center" style="display:none;"></div>
                    </div>
                    {# --- End Result Wrapper --- #}
                    <div id="gameModeModalsContainer">
                        {# JS will inject modal HTML here #}
                    </div>
                </div> {# End result-column-content #}
            </div> {# End Col 2.2 #}

        </div> {# End Row 2 #}

    </form> {# End Main Form #}

</div> {# End container #}

{# --- Pass data needed by JS (remains the same) --- #}
<script type="text/javascript">
    window.csrfToken = "{{ csrf_token() }}";
    window.generateChallengeUrl = "{{ url_for('challenge_api.generate_challenge') }}";
    window.shareChallengeUrl = "{{ url_for('challenge_api.share_challenge') }}";
    window.IS_AUTHENTICATED = {% if current_user.is_authenticated %}true{% else %}false{% endif %};
</script>

{% if not current_user.is_authenticated %}
<div id="loginReminderBox" class="floating-reminder-box">
    <button id="closeLoginReminderBox" class="close-btn" aria-label="Close">&times;</button>
    <h5><i class="bi bi-unlock-fill me-2"></i>Login for More Features!</h5>
    <ul class="feature-list">
        <li><i class="bi bi-people-fill me-1"></i> Share and use challenges with friends</li>
        <li><i class="bi bi-cloud-arrow-up-fill me-1"></i> Everything saved on server</li>
        <li><i class="bi bi-broadcast me-1"></i> Synchronized events for everyone</li>
        <li><i class="bi bi-display me-1"></i> OBS overlay integration</li>
        <li><i class="bi bi-joystick me-1"></i> Penalties matched to your current game</li>
    </ul>
    <a href="{{ url_for('auth.login') }}" class="btn btn-primary btn-sm w-100 mt-2">Login / Register</a>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
{{ super() }}
{# --- Load JS modules for this page (remains the same) --- #}
<script type="module" src="{{ url_for('static', filename='js/utils/helpers.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/games/localStorageUtils.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/penalties/penaltyLocalStorageUtils.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/challenge_generator/form.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/challenge_generator/share.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/easter_eggs/larry_mode.js') }}"></script>

{# Script for clamping inputs (remains the same) #}
<script>
    // window.IS_AUTHENTICATED = {% if current_user.is_authenticated %}true{% else %}false{% endif %}; // Removed duplicate
    const diffInput = document.getElementById('desiredDiff');
    const maxDiff = 1500;
    if (diffInput) {
        diffInput.addEventListener('input', () => {
            if (Number(diffInput.value) > maxDiff) diffInput.value = maxDiff;
        });
    }
    const maxGroupsInput = document.getElementById('maxGroups');
    const maxGroupsAllowed = 20;
    if (maxGroupsInput) {
        maxGroupsInput.addEventListener('input', () => {
            let currentValue = parseInt(maxGroupsInput.value, 10);
            if (isNaN(currentValue) || currentValue < 1) {
                // maxGroupsInput.value = 1;
            } else if (currentValue > maxGroupsAllowed) {
                maxGroupsInput.value = maxGroupsAllowed;
            }
        });
    }
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        if (typeof $ !== 'undefined' && $.fn.tooltip) {
            $('[data-toggle="tooltip"]').tooltip();
            console.log("Tooltips initialized.");
        } else {
            console.warn("jQuery or Bootstrap Tooltip component not found. Tooltips may not work.");
        }
    });
</script>
{% endblock %}
