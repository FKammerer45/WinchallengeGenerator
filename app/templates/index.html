{% extends "base.html" %}
{% block title %}Home - Win Challenge Generator{% endblock %}

{% block head %}
{{ super() }}
{# Base style.css is linked in base.html #}
{% endblock %}

{% block content %}
{# Added page-specific class for CSS targeting #}
<div class="container mt-4 index-page-container">
    {# --- Page Header --- #}
    <div class="text-center mb-5 pt-4">
        <h1 class="display-4 page-title mb-3">Win Challenge Generator</h1>
        <p class="lead text-secondary col-lg-8 mx-auto">Configure parameters and generate your next gaming challenge!
        </p>
    </div>

    <form id="challengeForm" method="post" action="{{ url_for('challenge_api.generate_challenge') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        {# --- Section 1: Source & Options --- #}
        {# Use standard card, styled by style.css #}
        <div class="card shadow-md mb-5">
            <div class="card-header h5 d-flex justify-content-between align-items-center">
                <span>1. Options</span>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-toggle="collapse"
                    data-target="#optionsBody" aria-expanded="true" aria-controls="optionsBody"
                    title="Toggle Options Section">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-chevron-expand" viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                            d="M3.646 9.146a.5.5 0 0 1 .708 0L8 12.793l3.646-3.647a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 0-.708m0-2.292a.5.5 0 0 0 .708 0L8 3.207l3.646 3.647a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 0 0 0 .708" />
                    </svg>
                </button>
            </div>
            <div class="collapse card-body" id="optionsBody">
                <div class="form-row align-items-center mb-3">
                    <div class="col-auto">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="enablePenalties"
                                name="use_penalties" {% if request.form.get('use_penalties') %}checked{% endif %}>
                            <label class="custom-control-label" for="enablePenalties">Enable Penalties on Game
                                Loss?</label>
                        </div>
                    </div>
                    <div class="col-auto d-none ml-3" id="penaltySourceContainer">
                        <select id="penaltySourceSelect" name="penalty_tab_id" class="form-control custom-select"
                            aria-label="Penalty Source Tab" style="width: auto; min-width: 150px;">
                            <option value="" disabled selected>Loading tabs...</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="challengeName">Challenge Name (Optional):</label>
                    <input type="text" id="challengeName" name="challenge_name" class="form-control"
                        placeholder="My Awesome Challenge" value="{{ request.form.get('challenge_name', '') }}">
                    <small class="form-text text-secondary">Give your challenge a name (used when sharing).</small>
                </div>

            </div>
        </div>

        {# --- Section 2: Mode & Parameters --- #}
        <div class="card shadow-md mb-5">
            <div class="card-header h5 d-flex justify-content-between align-items-center">
                <span>2. Mode & Parameters</span>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-toggle="collapse"
                    data-target="#modeParamsBody" aria-expanded="true" aria-controls="modeParamsBody"
                    title="Toggle Mode & Parameters Section">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-chevron-expand" viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                            d="M3.646 9.146a.5.5 0 0 1 .708 0L8 12.793l3.646-3.647a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 0-.708m0-2.292a.5.5 0 0 0 .708 0L8 3.207l3.646 3.647a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 0 0 0 .708" />
                    </svg>
                </button>
            </div>
            <div class="collapse card-body" id="modeParamsBody">
                <div class="form-group row mb-4 align-items-center"> {# Increased margin #}
                    <label class="col-sm-4 col-lg-3 col-form-label font-weight-bold">Challenge Mode:</label>
                    <div class="col-sm-8 col-lg-9">
                        <div class="custom-control custom-radio custom-control-inline">
                            <input class="custom-control-input mode-radio" type="radio" name="group_mode"
                                id="modeSingleGroup" value="single" {% if request.form.get('group_mode', 'single'
                                )=='single' %}checked{% endif %}>
                            <label class="custom-control-label" for="modeSingleGroup">Single Group </label>
                        </div>
                        <div class="custom-control custom-radio custom-control-inline">
                            <input class="custom-control-input mode-radio" type="radio" name="group_mode"
                                id="modeMultiGroup" value="multi" {% if request.form.get('group_mode')=='multi'
                                %}checked{% endif %}>
                            <label class="custom-control-label" for="modeMultiGroup">Multigroup </label>
                            <small class="text-warning login-required-msg ml-2 d-none">(Login required)</small>
                        </div>
                        <small class="form-text text-secondary d-block mt-1">Single saves locally. Multigroup requires
                            login.</small>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-6 col-lg-4">
                        <label for="numPlayers" class="font-weight-bold" id="numPlayersLabel">Number of Players:</label>
                        <select id="numPlayers" name="num_players" class="form-control custom-select">
                            <option value="1" {% if request.form.get('num_players', '1' )=='1' %}selected{% endif %}>1
                            </option>
                            <option value="2" {% if request.form.get('num_players')=='2' %}selected{% endif %}>2
                            </option>
                            <option value="3" {% if request.form.get('num_players')=='3' %}selected{% endif %}>3
                            </option>
                            <option value="4" {% if request.form.get('num_players')=='4' %}selected{% endif %}>4
                            </option>
                            <option value="5" {% if request.form.get('num_players')=='5' %}selected{% endif %}>5
                            </option>
                        </select>
                        <small class="form-text text-secondary">Scales difficulty appropriately.</small>
                    </div>
                    <div class="form-group col-md-6 col-lg-4 d-none" id="maxGroupsContainer">
                        <label for="maxGroups">Max Groups (Multigroup):</label>
                        <input type="number" id="maxGroups" name="max_groups" class="form-control"
                            value="{{ request.form.get('max_groups', 10) }}" min="1" max="50">
                        <small class="form-text text-secondary">Max groups allowed when shared.</small>
                    </div>
                </div>
                <div class="form-row mt-3 align-items-center">
                    <div class="form-group col-md-6 col-lg-4">
                        <label for="desiredDiff" class="font-weight-bold">Target Difficulty:</label>
                        <input type="number" step="0.1" id="desiredDiff" name="desired_diff" class="form-control"
                            placeholder="e.g., 60.0" required value="{{ request.form.get('desired_diff', 60) }}">
                    </div>
                    <div class="form-group col-md-12 col-lg-8">
                        <label for="spinB2B" class="font-weight-bold">
                            Back-to-Back Probability: <output class="badge badge-secondary ml-2 range-value-display">{{
                                request.form.get('raw_b2b', 1) }}</output>
                        </label>
                        <input type="range" id="spinB2B" name="raw_b2b" class="custom-range" min="0" max="10" step="1"
                            value="{{ request.form.get('raw_b2b', 1) }}"
                            oninput="this.previousElementSibling.querySelector('output').textContent = this.value">
                        <div class="d-flex justify-content-between w-100 px-1"> <small
                                class="text-secondary">None</small>
                            <small class="text-secondary">High</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# --- Section 3: Select Games & Modes --- #}
        <div class="card shadow-md mb-5">
            <div class="card-header h5 d-flex justify-content-between align-items-center">
                <span>3. Select Games & Modes</span>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-toggle="collapse"
                    data-target="#gamesModesBody" aria-expanded="true" aria-controls="gamesModesBody"
                    title="Toggle Games & Modes Section">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-chevron-expand" viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                            d="M3.646 9.146a.5.5 0 0 1 .708 0L8 12.793l3.646-3.647a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 0-.708m0-2.292a.5.5 0 0 0 .708 0L8 3.207l3.646 3.647a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 0 0 0 .708" />
                    </svg>
                </button>
            </div>
            <div class="collapse show" id="gamesModesBody">
                <div class="d-flex align-items-end flex-wrap px-3 pt-3">
                    <!-- dropdown -->
                    <div class="form-group mb-2 mr-auto"> <!-- mr‑auto pushes buttons right -->
                        <label for="gameSourceSelect">Game Entries Source Tab:</label>
                        <select id="gameSourceSelect" name="game_tab_id" class="form-control custom-select">
                            <option value="" disabled selected>Loading tabs...</option>
                        </select>
                        <small class="form-text text-secondary">
                            Select the tab containing the games list.
                        </small>
                    </div>

                    <!-- buttons -->
                    <div class="btn-group mb-2">
                        <button type="button" id="selectAllGamesBtn" class="btn btn-sm btn-outline-primary">
                            Select&nbsp;All
                        </button>
                        <button type="button" id="deselectAllGamesBtn" class="btn btn-sm btn-outline-secondary">
                            Deselect&nbsp;All
                        </button>
                    </div>
                </div>
                <div class="card-body p-0"> {# Remove padding for full-width table wrapper #}

                    <div class="table-responsive game-selection-table-wrapper">
                        <table class="table table-hover table-sm mb-0 game-selection-table"> {# Removed table-dark #}
                            <thead> {# Thead styled by CSS #}
                                <tr>
                                    <th style="width:45%;">Game</th>
                                    <th style="width:15%;">Weight</th>
                                    <th style="width:40%;">Allowed Modes</th>
                                </tr>
                            </thead>
                            <tbody id="gamesSelectionTbody">
                                <tr>
                                    <td colspan="3" class="text-center text-secondary py-4">Select Game Source Tab
                                        above...
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr id="showMoreGamesRow" class="d-none">
                                    <td colspan="3" class="text-center py-2">
                                        <button type="button" id="showLessGamesBtn"
                                            class="btn btn-outline-secondary btn-sm mr-2 d-none">
                                            ▲ Show less
                                        </button>

                                        <button type="button" id="showMoreGamesBtn"
                                            class="btn btn-outline-primary btn-sm">
                                            ▼ Show more
                                        </button>
                                    </td>
                                </tr>
                            </tfoot>


                        </table>
                    </div>
                </div>

            </div>
        </div>
        {# --- Form Error Display --- #}
        <div id="formErrorDisplay" class="alert alert-danger text-center" style="display: none;"></div>

        {# --- Submit Button --- #}
        {# Use btn-warning for the secondary accent color #}
        <button type="submit" class="btn btn-warning btn-lg btn-block mt-4 mb-5 shadow-lg generate-btn">
            <span class="spinner-border spinner-border-sm" style="display: none;"></span>
            <span>Generate Challenge</span>
        </button>
    </form>

    {# --- Result Section --- #}
    <hr class="my-5">
    <div id="challengeResultWrapper" class="mb-5" style="display:none;">
        <h2 class="mb-4 text-light text-center">Generated Challenge</h2>
        {# Apply glass effect to result card #}
        <div id="challengeResult" class="card p-4 mb-3 shadow-lg result-card glass-effect">
            <p class="text-center text-secondary">Loading result...</p>
        </div>
        <div class="result-actions text-center mt-4">
            {% if current_user.is_authenticated %}
            {# Use btn-info (mapped to primary blue) #}
            <button id="shareChallengeBtn" class="btn btn-info btn-lg mx-2 action-btn" style="display:none;">
                <span class="spinner-border spinner-border-sm"></span>
                <span>Share Challenge</span>
            </button>
            {% endif %}
            <a href="#" id="viewLocalChallengeBtn" class="btn btn-secondary btn-lg mx-2 action-btn"
                style="display:none;" role="button" target="_blank">View Locally Saved Challenge</a>
        </div>
        <div id="shareResult" class="mt-3 share-result-display" style="display:none;"></div>
    </div>

</div> {# End container #}

{# --- Pass data needed by JS --- #}
<script>
    window.csrfToken = "{{ csrf_token() }}";
    window.generateChallengeUrl = "{{ url_for('challenge_api.generate_challenge') }}";
    window.shareChallengeUrl = "{{ url_for('challenge_api.share_challenge') }}";
    window.IS_AUTHENTICATED = {{ current_user.is_authenticated | lower }};
</script>
{% endblock %}

{% block scripts %}
{{ super() }}
<script type="module" src="{{ url_for('static', filename='js/challenge_generator/form.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/challenge_generator/share.js') }}"></script>
{% endblock %}