{# templates/payment/checkout_page.html #}
{% extends "base.html" %}
{% block title %}Upgrade to Pro - Checkout{% endblock %}

{% block head %}
{{ super() }}
{# Add specific CSS for checkout page if needed later #}
{# <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/checkout.css') }}"> #}

{# --- IMPORTANT: Add Payment Provider JS SDK --- #}
{# PayPal JavaScript SDK #}
{% if paypal_client_id %}
<script src="https://www.paypal.com/sdk/js?client-id={{ paypal_client_id }}&currency={{ pro_plan_currency | default('EUR') }}&intent=capture"></script>
{% else %}
<!-- PayPal Client ID not configured -->
{% endif %}

<style>
  /* Basic styling for placeholder */
  .checkout-container {
    max-width: 600px;
    margin: 2rem auto;
  }
  .payment-placeholder {
    border: 2px dashed var(--surface-border);
    padding: 3rem 1.5rem;
    text-align: center;
    border-radius: var(--border-radius-lg);
    background-color: rgba(0,0,0,0.1);
  }
  .payment-placeholder i {
    font-size: 3rem;
    color: var(--accent-primary);
    margin-bottom: 1rem;
    display: block;
  }
  .payment-placeholder p {
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4 checkout-container">

    {% if is_testing_or_debug %}
    {# --- Test/Development Buttons --- #}
    <div class="card shadow-sm glass-effect mb-4">
        <div class="card-header h5 d-flex align-items-center">
            <i class="bi bi-tools me-2"></i> Development/Testing Actions
        </div>
        <div class="card-body">
            <p class="text-secondary small mb-3">These buttons are only visible in development or testing environments for easy plan management.</p>
            <form action="{{ url_for('main.test_acquire_pro') }}" method="post" class="d-inline-block me-2">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-success btn-sm">Acquire Pro Plan (Test)</button>
            </form>
            <form action="{{ url_for('main.test_remove_pro') }}" method="post" class="d-inline-block">
                 <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                 <button type="submit" class="btn btn-danger btn-sm">Remove Pro Plan (Test)</button>
            </form>
        </div>
    </div>
    {# --- End Test/Development Buttons --- #}
    {% endif %}

    <div class="text-center mb-5">
        <h1 class="display-5 page-title mb-3">Upgrade to Pro Plan</h1>
        <p class="lead text-secondary">Complete your secure payment below.</p>
    </div>

    <div class="card glass-effect mb-4">
        <div class="card-body p-4 p-lg-5">
            <h4 class="mb-4">Order Summary</h4>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="fw-bold"><i class="bi bi-gem me-2 text-primary-accent"></i>Pro Plan (Monthly)</span>
                <span class="fw-bold">€2.99</span>
            </div>
            <hr style="border-color: var(--surface-border);">
             <div class="d-flex justify-content-between align-items-center fw-bold mt-3">
                <span>Total</span>
                <span>€2.99 / month</span>
            </div>
        </div>
    </div>

    <div class="card glass-effect">
         <div class="card-header h5">
            Payment Details
         </div>
        <div class="card-body p-4 p-lg-5">
            {% if user_already_pro %}
            <div class="alert alert-success text-center">
                <h4 class="alert-heading"><i class="bi bi-patch-check-fill me-2"></i>You are already a Pro Member!</h4>
                <p>Your current Pro Plan is active{% if pro_expiration_date_str %} until <strong>{{ pro_expiration_date_str }}</strong>{% endif %}.</p>
                <p>You can manage your subscription from your <a href="{{ url_for('profile.profile_view') }}" class="alert-link">profile page</a>.</p>
                <hr>
                <p class="mb-0">If you believe this is an error, please contact support.</p>
            </div>
            {% else %}
            {# --- Payment Provider Integration Placeholder --- #}
            {# This is where you would integrate Stripe Elements, PayPal button, etc. #}
            {# --- PayPal Button Container --- #}
            <div id="paypal-button-container">
                {% if not paypal_client_id %}
                <div class="alert alert-warning text-center">
                    PayPal payments are currently unavailable as the system is not configured.
                </div>
                {% endif %}
            </div>
            <div id="payment-message" class="mt-3 text-center"></div> 
            {# --- End PayPal Button Container --- #}
            {% endif %}
        </div>
    </div>

</div> {# End container #}
{% endblock %}

{% block scripts %}
{{ super() }}
{# Only render PayPal button script if user is NOT already pro AND paypal_client_id exists #}
{% if not user_already_pro and paypal_client_id %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const paypalButtonContainer = document.getElementById('paypal-button-container');
    const paymentMessage = document.getElementById('payment-message');
    const csrfToken = "{{ csrf_token() }}"; // Get CSRF token from Flask

    if (paypalButtonContainer && typeof paypal !== 'undefined') {
        paypal.Buttons({
            // Style the button
            style: {
                layout: 'vertical', // 'vertical' or 'horizontal'
                color:  'gold',    // 'gold', 'blue', 'silver', 'black'
                shape:  'rect',    // 'rect', 'pill'
                label:  'pay',     // 'paypal', 'pay', 'buynow', 'checkout', 'subscribe'
                height: 45
            },

            // Call your server to set up the transaction
            createOrder: async function(data, actions) {
                paymentMessage.innerHTML = ''; // Clear previous messages
                try {
                    const response = await fetch("{{ url_for('payment.create_paypal_order') }}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken 
                        },
                        // No body needed if amount is fixed on server
                    });
                    const orderData = await response.json();
                    // Backend now returns { "id": "ORDER_ID_HERE" }
                    if (orderData.id) { 
                        console.log("PayPal order created by backend, Order ID from server:", orderData.id);
                        return orderData.id; // This ID is passed to PayPal SDK
                    } else {
                        console.error("Backend failed to return order.id:", orderData.error, orderData.details);
                        paymentMessage.innerHTML = `<div class="alert alert-danger">Error creating order with server: ${orderData.error || 'Unknown error from server'}. Please try again.</div>`;
                        throw new Error(orderData.error || "Failed to create order with server (missing id).");
                    }
                } catch (error) {
                    console.error("Error in createOrder:", error);
                    paymentMessage.innerHTML = `<div class="alert alert-danger">Could not initiate PayPal payment. ${error.message}</div>`;
                    throw error; // Re-throw to stop PayPal flow
                }
            },

            // Call your server to finalize the transaction
            onApprove: async function(data, actions) {
                paymentMessage.innerHTML = '<div class="alert alert-info">Processing your payment... <span class="spinner-border spinner-border-sm"></span></div>';
                try {
                    const response = await fetch("{{ url_for('payment.capture_paypal_order') }}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({
                            orderID: data.orderID // data.orderID is provided by PayPal
                        })
                    });
                    const captureData = await response.json();
                    if (captureData.status === 'success') {
                        console.log("PayPal payment captured:", captureData);
                        paymentMessage.innerHTML = `<div class="alert alert-success">${captureData.message} Redirecting...</div>`;
                        // Redirect to profile or a success page after a short delay
                        setTimeout(() => {
                            window.location.href = "{{ url_for('profile.profile_view') }}"; 
                        }, 3000);
                    } else {
                        console.error("Failed to capture PayPal payment:", captureData.error, captureData.details);
                        paymentMessage.innerHTML = `<div class="alert alert-danger">Payment capture failed: ${captureData.error || 'Unknown error'}. ${captureData.details ? JSON.stringify(captureData.details) : ''} Please contact support.</div>`;
                    }
                } catch (error) {
                    console.error("Error in onApprove:", error);
                    paymentMessage.innerHTML = `<div class="alert alert-danger">Error processing payment. ${error.message}</div>`;
                }
            },

            onError: function(err) {
                console.error("PayPal button error:", err);
                paymentMessage.innerHTML = `<div class="alert alert-danger">An error occurred with the PayPal payment. Please try again or contact support. Details: ${err.toString()}</div>`;
            },

            onCancel: function(data) {
                console.log("PayPal payment cancelled:", data);
                paymentMessage.innerHTML = `<div class="alert alert-warning">Payment cancelled.</div>`;
            }
        }).render('#paypal-button-container').catch(err => {
            console.error("Failed to render PayPal buttons:", err);
            paymentMessage.innerHTML = `<div class="alert alert-danger">Could not load PayPal payment options. Please ensure third-party scripts are not blocked and try again.</div>`;
        });
    } else if (!paypal_client_id) {
        console.warn("PayPal Client ID not configured, PayPal buttons not rendered.");
    } else {
        console.error("PayPal SDK not loaded or paypal-button-container not found.");
         if(paypalButtonContainer) paypalButtonContainer.innerHTML = `<div class="alert alert-danger">Could not load PayPal payment options. Please try refreshing the page.</div>`;
    }
});
</script>
{% endif %}
{% endblock %}
