{# templates/challenge/_challenge_group_progress.html #}
{# Renders the INTERACTIVE progress checkboxes for a specific group #}
{# Expects:
    challenge (the full shared_challenge object, used for context but not directly here)
    group (a dictionary containing group data, including 'id' and 'progress')
    is_member (boolean: True if current_user viewing the page is in this group)
#}

{# Get challenge data from the passed challenge object if needed, otherwise assume structure is in group?
   Let's assume 'c' still comes from the parent template context for challenge structure #}
{% set c = challenge.challenge_data %} {# Assumes 'challenge' is passed correctly when including this template #}

{# *** FIX: Access the progress data using the 'progress' key from the group dictionary *** #}
{% set group_progress = group.progress or {} %} {# Use group.progress #}
{% set group_id = group.id %}

{% if c %}
<div class="group-progress-container">

    {# Normal Wins Progress #}
    {% if c.normal %}
        <h6 class="text-info small">Normal Wins Progress:</h6>
        {% for key, info in c.normal.items()|sort %}
            <div class="mb-2">
                <strong class="small d-block">{{ key | escape }} ({{ info.count }} needed):</strong>
                <div class="progress-markers pl-2">
                    {% for i in range(info.count|int) %}
                        {# --- Checkbox for Normal Win --- #}
                        {% set item_type = 'normal' %}
                        {% set item_key = key %}
                        {% set item_index = i %}
                        {% set progress_key = item_type ~ '_' ~ item_key ~ '_' ~ item_index %}
                        {# Use the corrected group_progress variable #}
                        {% set is_checked = group_progress.get(progress_key, False) %}
                        {% set safe_id_key = progress_key | replace(' ', '_') | replace('(', '') | replace(')', '') %}
                        {% set input_id = 'check_' ~ group_id ~ '_' ~ safe_id_key %}

                        <div class="form-check form-check-inline progress-item {% if is_checked %}completed{% endif %}" data-progress-key="{{ progress_key }}">
                          <input type="checkbox"
                                 class="form-check-input progress-checkbox"
                                 id="{{ input_id }}"
                                 aria-label="Win {{ i+1 }} for {{ key | escape }}"
                                 data-group-id="{{ group_id }}"
                                 data-item-type="{{ item_type }}"
                                 data-item-key="{{ item_key | escape }}"
                                 data-item-index="{{ item_index }}"
                                 {% if is_checked %}checked{% endif %}
                                 {% if not is_member %}disabled{% endif %}
                                 >
                          <label class="form-check-label" for="{{ input_id }}">
                             <span class="sr-only">Win {{ i+1 }} for {{ key | escape }}</span>
                          </label>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    {% endif %}

    {# Back-to-Back Wins Progress #}
    {% if c.b2b %}
        {% if c.normal %}<hr class="border-secondary my-2">{% endif %}
        <h6 class="text-warning small">B2B Segment Progress:</h6>
        {% for seg in c.b2b %}
            {% set outer_loop_index = loop.index %}
             <div class="mb-2">
                <strong class="small d-block">Segment {{ outer_loop_index }}:</strong>
                {% for key, count in seg.group.items()|sort %}
                    <div class="pl-2 mb-1">
                         <span class="small d-inline-block mr-2">{{ key | escape }} ({{ count }} needed):</span>
                        <div class="progress-markers d-inline-block">
                            {% for i in range(count|int) %}
                                {# --- Checkbox for B2B Win --- #}
                                {% set item_type = 'b2b' %}
                                {% set item_key = key %}
                                {% set item_index = i %}
                                {% set segment_index = outer_loop_index %}
                                {% set progress_key = item_type ~ '_' ~ segment_index ~ '_' ~ item_key ~ '_' ~ item_index %}
                                {# Use the corrected group_progress variable #}
                                {% set is_checked = group_progress.get(progress_key, False) %}
                                {% set safe_id_key = progress_key | replace(' ', '_') | replace('(', '') | replace(')', '') %}
                                {% set input_id = 'check_' ~ group_id ~ '_' ~ safe_id_key %}

                                <div class="form-check form-check-inline progress-item {% if is_checked %}completed{% endif %}" data-progress-key="{{ progress_key }}">
                                  <input type="checkbox"
                                         class="form-check-input progress-checkbox"
                                         id="{{ input_id }}"
                                         aria-label="Segment {{ segment_index }} Win {{ i+1 }} for {{ key | escape }}"
                                         data-group-id="{{ group_id }}"
                                         data-item-type="{{ item_type }}"
                                         data-item-key="{{ item_key | escape }}"
                                         data-item-index="{{ item_index }}"
                                         data-segment-index="{{ segment_index }}"
                                         {% if is_checked %}checked{% endif %}
                                         {% if not is_member %}disabled{% endif %}
                                         >
                                   <label class="form-check-label" for="{{ input_id }}">
                                       <span class="sr-only">Segment {{ segment_index }} Win {{ i+1 }} for {{ key | escape }}</span>
                                   </label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
             </div>
        {% endfor %}
    {% endif %}

    {# Fallback if challenge structure is missing or empty #}
    {% if not c.normal and not c.b2b %}
        <p class="text-muted small">No progress items defined for this challenge.</p>
    {% endif %}
</div>
{% else %}
    <p class="text-danger">Error: Challenge data ('c') not provided to progress template.</p>
{% endif %}
