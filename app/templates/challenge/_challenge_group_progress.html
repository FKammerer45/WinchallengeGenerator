{# templates/challenge/_challenge_group_progress.html #}
{# Renders the INTERACTIVE progress checkboxes for a specific group #}
{# Expects: challenge, group, is_member context variables #}

{% set c = challenge.challenge_data %}
{% set group_progress = group.progress or {} %} {# Use 'progress' key from dict #}
{% set group_id = group.id %}
{# Determine if checkboxes should be interactive based on membership and login status #}
{% set is_interactive = is_member and current_user.is_authenticated %}

{% if c %}
<div class="group-progress-container mt-3"> {# Added margin-top #}

    {# Normal Wins Progress #}
    {% if c.normal %}
        <h6 class="text-info small font-weight-bold mb-2">Normal Wins Progress:</h6> {# Use info color (blue) #}
        {% for key, info in c.normal.items()|sort %}
            <div class="mb-2">
                <strong class="small d-block text-light">{{ key | escape }} ({{ info.count }} needed):</strong>
                <div class="progress-markers pl-2">
                    {% for i in range(info.count|int) %}
                        {% set item_type = 'normal' %}
                        {% set item_key = key %}
                        {% set item_index = i %}
                        {% set progress_key = item_type ~ '_' ~ item_key ~ '_' ~ item_index %}
                        {% set is_checked = group_progress.get(progress_key, False) %}
                        {% set safe_id_key = progress_key | replace(' ', '_') | replace('(', '') | replace(')', '') %}
                        {% set input_id = 'check_' ~ group_id ~ '_' ~ safe_id_key %}

                        {# Use custom controls styled by style.css #}
                        <div class="custom-control custom-checkbox d-inline-block mr-2 progress-item {% if is_checked %}completed{% endif %}" data-progress-key="{{ progress_key }}">
                          <input type="checkbox"
                                 class="custom-control-input progress-checkbox"
                                 id="{{ input_id }}"
                                 aria-label="Win {{ i+1 }} for {{ key | escape }}"
                                 data-group-id="{{ group_id }}"
                                 data-item-type="{{ item_type }}"
                                 data-item-key="{{ item_key | escape }}"
                                 data-item-index="{{ item_index }}"
                                 {% if is_checked %}checked{% endif %}
                                 {# Disable based on interactivity flag #}
                                 {% if not is_interactive %}disabled{% endif %}
                                 >
                          <label class="custom-control-label" for="{{ input_id }}">
                             {# Label text can be hidden if checkbox is styled clearly #}
                             <span class="sr-only">Win {{ i+1 }} for {{ key | escape }}</span>
                          </label>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    {% endif %}

    {# Back-to-Back Wins Progress #}
    {% if c.b2b %}
        {% if c.normal %}<hr class="my-3">{% endif %} {# Use standard hr #}
        <h6 class="text-secondary-accent small font-weight-bold mb-2">B2B Segment Progress:</h6> {# Use secondary accent (pink) #}
        {% for seg in c.b2b %}
            {% set outer_loop_index = loop.index %}
             <div class="mb-2">
                <strong class="small d-block text-light">Segment {{ outer_loop_index }}:</strong>
                {% for key, count in seg.group.items()|sort %}
                    <div class="pl-2 mb-1">
                         <span class="small d-inline-block mr-2 text-light">{{ key | escape }} ({{ count }} needed):</span>
                        <div class="progress-markers d-inline-block">
                            {% for i in range(count|int) %}
                                {% set item_type = 'b2b' %}
                                {% set item_key = key %}
                                {% set item_index = i %}
                                {% set segment_index = outer_loop_index %}
                                {% set progress_key = item_type ~ '_' ~ segment_index ~ '_' ~ item_key ~ '_' ~ item_index %}
                                {% set is_checked = group_progress.get(progress_key, False) %}
                                {% set safe_id_key = progress_key | replace(' ', '_') | replace('(', '') | replace(')', '') %}
                                {% set input_id = 'check_' ~ group_id ~ '_' ~ safe_id_key %}

                                <div class="custom-control custom-checkbox d-inline-block mr-2 progress-item {% if is_checked %}completed{% endif %}" data-progress-key="{{ progress_key }}">
                                  <input type="checkbox"
                                         class="custom-control-input progress-checkbox"
                                         id="{{ input_id }}"
                                         aria-label="Segment {{ segment_index }} Win {{ i+1 }} for {{ key | escape }}"
                                         data-group-id="{{ group_id }}"
                                         data-item-type="{{ item_type }}"
                                         data-item-key="{{ item_key | escape }}"
                                         data-item-index="{{ item_index }}"
                                         data-segment-index="{{ segment_index }}"
                                         {% if is_checked %}checked{% endif %}
                                         {% if not is_interactive %}disabled{% endif %}
                                         >
                                   <label class="custom-control-label" for="{{ input_id }}">
                                       <span class="sr-only">Segment {{ segment_index }} Win {{ i+1 }} for {{ key | escape }}</span>
                                   </label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
             </div>
        {% endfor %}
    {% endif %}

    {# Fallback if challenge structure is missing or empty #}
    {% if not c.normal and not c.b2b %}
        <p class="text-secondary small">No progress items defined for this challenge.</p>
    {% endif %}
</div>
{% else %}
    <p class="text-danger">Error: Challenge data ('c') not provided to progress template.</p>
{% endif %}
