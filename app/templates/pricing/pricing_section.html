{# templates/pricing/pricing_section.html #}
{% extends "base.html" %}
{% block title %}Subscription Plans - Win Challenge Generator{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/pricing.css') }}">
{% endblock %}

{% block content %}
<div class="container mt-5 pt-4 mb-5 subscribe-page">

    {# --- Page Header --- #}
    <div class="text-center mb-5">
        <h1 class="display-4 page-title mb-3">Choose Your Plan</h1>
        <p class="lead text-secondary col-lg-8 mx-auto">Unlock enhanced features and support the platform by upgrading to Pro.</p>
        {% if not current_user.is_authenticated %}
        <div class="alert alert-info mt-3 col-lg-6 mx-auto">
            <i class="bi bi-info-circle-fill me-2"></i>You need to <a href="{{ url_for('auth.login', next=url_for('main.subscribe')) }}" class="alert-link">login</a> or <a href="{{ url_for('auth.register', next=url_for('main.subscribe')) }}" class="alert-link">register</a> to select a plan.
        </div>
        {% endif %}
    </div>

    {# --- Pricing Section --- #}
    <section class="pricing-section">
        <div class="row justify-content-center g-4">

            {# --- Free Plan Card --- #}
            <div class="col-lg-5 col-md-6">
                <div class="plan-card free-plan glass-effect h-100 d-flex flex-column">
                    <div class="card-body p-4 p-lg-5">
                        <h3 class="plan-name mb-3 d-flex align-items-center">
                            <i class="bi bi-box-seam me-2 fs-4"></i>
                            Free Plan
                        </h3>
                        <p class="plan-price display-5 fw-bold mb-2">€0<span
                                class="fs-4 fw-normal text-secondary">/month</span></p>
                        <p class="plan-description text-secondary mb-4">
                            Perfect for beginners to explore win challenges.
                        </p>
                        <hr class="feature-divider">
                        <ul class="features-list list-unstyled mb-4">
                            {% for feature in FREE_PLAN_DISPLAY_FEATURES %}
                            <li class="feature-item"><i class="bi bi-check-circle-fill text-success me-2"></i>{{ feature }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="card-footer p-4 p-lg-5 mt-auto text-center">
                        {% if current_user.is_authenticated %}
                            {% if user_is_pro %} {# user_is_pro is passed from the route #}
                                <button class="btn btn-secondary w-100 disabled" aria-disabled="true">Currently Pro</button>
                            {% else %}
                                <button class="btn btn-secondary w-100 disabled" aria-disabled="true">Your Current Plan</button>
                            {% endif %}
                        {% else %}
                            <a href="{{ url_for('auth.register', next=url_for('main.subscribe')) }}" class="btn btn-outline-primary w-100">Login to use</a>
                        {% endif %}
                    </div>
                </div>
            </div>

            {# --- Pro Plan Card --- #}
            <div class="col-lg-5 col-md-6">
                <div class="plan-card pro-plan glass-effect highlighted h-100 d-flex flex-column">
                    <div class="card-body p-4 p-lg-5">
                        <div class="popular-badge">Meow :3</div>
                        <h3 class="plan-name mb-3 d-flex align-items-center">
                            <i class="bi bi-gem me-2 fs-4 text-primary-accent"></i>
                            Pro Plan
                        </h3>
                        <p class="plan-price display-5 fw-bold mb-2">€2.99<span
                                class="fs-4 fw-normal text-secondary">/month</span></p>
                        <p class="plan-description text-secondary mb-4">
                            For creators who want to boost engagement and unlock all features.
                        </p>
                        <hr class="feature-divider">
                        <ul class="features-list list-unstyled mb-4">
                            <li class="feature-item"><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Everything from Free Plan, plus:</strong></li>
                            {% for feature in PRO_PLAN_DISPLAY_FEATURES %}
                            <li class="feature-item"><i class="bi bi-check-circle-fill text-success me-2"></i>{{ feature }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="card-footer p-4 p-lg-5 mt-auto text-center">
                        {% if current_user.is_authenticated %}
                            {% if user_is_pro %} {# user_is_pro is passed from the route #}
                                <button class="btn btn-success w-100 disabled" aria-disabled="true">
                                    <i class="bi bi-heart-fill"></i> Thank You!
                                </button>
                            {% else %}
                                <a href="{{ url_for('payment.checkout') }}" class="btn btn-primary w-100 cta-button">Upgrade to Pro</a>
                            {% endif %}
                        {% else %}
                            <a href="{{ url_for('auth.register', next=url_for('main.subscribe')) }}" class="btn btn-primary w-100 cta-button">Login to use</a>
                        {% endif %}
                    </div>
                </div>

                {# --- MOVE CAT CONTAINER HERE --- #}
                <div id="running-cat-local-container">
                    <img id="running-cat-local-gif" src="{{ url_for('static', filename='images/maxwell-cat.gif') }}"
                        alt="Animated cat" onerror="this.style.display='none'">
                    {# --- ADD SPEECH BUBBLE INSIDE CAT CONTAINER --- #}
                    <div id="cat-speech-bubble" class="speech-bubble">
                        meow im maxwell
                    </div>
                    {# --- END SPEECH BUBBLE --- #}
                </div>
                {# --- END CAT CONTAINER --- #}
            </div> {# End Card Footer #}
        </div>

</div> {# End row #}



</section> {# End pricing-section #}

</div> {# End container #}
{% endblock %}

{% block scripts %}
{{ super() }}
<script type="module" src="{{ url_for('static', filename='js/utils/soundManager.js') }}"></script>

{# --- MODIFIED SCRIPT BLOCK --- #}
<script type="module">
    document.addEventListener('DOMContentLoaded', function () {
        const originalCatImg = document.getElementById('running-cat-local-gif');
        const originalCatContainer = document.getElementById('running-cat-local-container');
        const speechBubble = document.getElementById('cat-speech-bubble');
        const pageContainer = document.querySelector('.subscribe-page') || document.body;
        const meowSoundUrl = "{{ url_for('static', filename='sounds/meow_1.mp3') }}";
        const crabRaveSoundUrl = "{{ url_for('static', filename='sounds/crabrave.mp3') }}"; // <-- CHANGE FILENAME IF NEEDED

        let clickCount = 0;
        const clickThreshold = 20;
        let isExploding = false;
        let bubbleTimeout;
        let crabRaveAudio = null; // Variable to hold the looping audio object

        if (originalCatImg && window.soundManager) {
            originalCatImg.addEventListener('click', function () {
                if (isExploding) return;

                
                window.soundManager.playSound(meowSoundUrl);

                clickCount++;
                console.log(`Maxwell Click Count: ${clickCount}`);

                if (clickCount >= clickThreshold) {
                    console.log("Triggering Maxwell CRAB RAVE!");
                    triggerCatExplosion(); // Renamed for clarity maybe? No, keep name.
                    clickCount = 0;
                }

                // Speech Bubble Logic
                clearTimeout(bubbleTimeout);
                if (speechBubble) {
                    speechBubble.classList.add('show');
                    bubbleTimeout = setTimeout(() => {
                        speechBubble.classList.remove('show');
                    }, 3000);
                }
            });
        } else {
            if (!originalCatImg) console.warn("Maxwell cat image not found.");
            if (!window.soundManager) console.warn("Sound manager not loaded.");
        }

        function triggerCatExplosion() {
            if (isExploding) return;
            isExploding = true;
            clickCount = 0;

            // 1. Hide Original Cat & Bubble
            if (originalCatContainer) {
                 originalCatContainer.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                 originalCatContainer.style.opacity = '0';
                 originalCatContainer.style.transform = 'scale(0)'; // Shrink away instead of pop
            }
             if (speechBubble) speechBubble.classList.remove('show');

            // *** Play Crab Rave (Looping) ***
            if (crabRaveSoundUrl && window.soundManager) {
                // Stop previous instance if it exists (important for rapid re-triggering)
                if(crabRaveAudio && !crabRaveAudio.paused) {
                    crabRaveAudio.pause();
                    crabRaveAudio.currentTime = 0;
                }
                crabRaveAudio = window.soundManager.playSound(crabRaveSoundUrl, true); // Play looped, store instance
            }

            // 2. Create Clones
            const numClones = 20;
            const clones = [];
            const originalRect = originalCatImg.getBoundingClientRect();
            // Use viewport dimensions for initial random placement
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;


            for (let i = 0; i < numClones; i++) {
                const clone = document.createElement('img');
                clone.src = originalCatImg.src;
                clone.classList.add('exploding-cat'); // Base style

                // *** Start clones at random positions across the screen ***
                const initialX = Math.random() * (viewportWidth - 90) + 45; // Random X (padding)
                const initialY = Math.random() * (viewportHeight - 90) + 45; // Random Y (padding)
                clone.style.left = `${initialX}px`;
                clone.style.top = `${initialY}px`;
                // Apply random animation delay so they don't all dance in sync
                clone.style.animationDelay = `${Math.random() * 0.5}s`;

                pageContainer.appendChild(clone);
                clones.push(clone);

                // Add the 'fly' class slightly after appending to trigger fade-in/scale-up
                // and start the CSS keyframe animation
                requestAnimationFrame(() => {
                     setTimeout(() => { // Timeout ensures style is applied before class change
                         clone.classList.add('fly');
                     }, 10);
                });
            }

            // 3. Cleanup after 10 seconds (Increased duration)
            setTimeout(() => {
                // Stop Crab Rave
                if(crabRaveAudio && !crabRaveAudio.paused) {
                    crabRaveAudio.pause();
                    crabRaveAudio.currentTime = 0; // Reset for next time
                    crabRaveAudio = null; // Clear reference
                }

                // Fade out and remove clones
                clones.forEach(clone => {
                    clone.style.animationPlayState = 'paused'; // Stop animation
                    clone.classList.remove('fly'); // Remove fly class if needed
                    clone.classList.add('fade-out');
                    clone.addEventListener('transitionend', () => clone.remove(), { once: true });
                });

                // Bring back original cat
                setTimeout(() => {
                    if (originalCatContainer) {
                        originalCatContainer.style.opacity = '1';
                        originalCatContainer.style.transform = 'scale(1)';
                    }
                     isExploding = false;
                     console.log("Maxwell rave finished.");
                }, 600); // Wait for fade-out

            }, 10000); // *** Increased duration to 10 seconds ***
        }

   

    });
</script>
{# --- END OF SCRIPT BLOCK --- #}
{% endblock %}
