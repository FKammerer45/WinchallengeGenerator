{# app/templates/profile/profile.html #}
{% extends "base.html" %}
{% from "_form_helpers.html" import render_field %} {# Import macro #}

{% block title %}My Profile{% endblock %}

{% block head %}
{{ super() }}
<style>
    .profile-container {
        max-width: 800px; /* Slightly wider for better layout */
        margin: 2rem auto;
        padding: 1.5rem;
        background-color: var(--surface-background); /* Subtle background for the container */
        border-radius: var(--border-radius-lg);
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .profile-card {
        background-color: var(--surface-primary); /* Card background */
        border: 1px solid var(--surface-border);
        border-radius: var(--border-radius-md);
        margin-bottom: 2rem;
        box-shadow: var(--shadow-sm);
    }

    .profile-card .card-header {
        background-color: var(--surface-secondary); /* Header background */
        border-bottom: 1px solid var(--surface-border);
        font-size: 1.1rem; /* Slightly larger header font */
        font-weight: 600;
        padding: 0.75rem 1.25rem;
        display: flex;
        align-items: center;
    }
    .profile-card .card-header i {
        margin-right: 0.75rem;
        font-size: 1.2em;
        color: var(--text-primary);
    }

    .profile-card .card-body {
        padding: 1.5rem;
        line-height: 1.6;
    }

    .profile-card .card-body p {
        margin-bottom: 0.75rem;
    }
    .profile-card .card-body strong {
        color: var(--text-primary);
    }
    .profile-card .card-body hr {
        margin-top: 1rem;
        margin-bottom: 1rem;
        border-top: 1px solid var(--surface-border-light);
    }

    .email-status {
        font-size: 0.85em;
        font-weight: 600;
        padding: 0.3em 0.6em;
    }
    .email-status-verified {
        background-color: var(--success-subtle) !important;
        color: var(--success-emphasis) !important;
    }
    .email-status-unverified {
        background-color: var(--warning-subtle) !important;
        color: var(--warning-emphasis) !important;
    }

    #overlayApiKey {
        background-color: var(--surface-secondary);
        cursor: text;
        border-color: var(--surface-border);
    }
    .input-group-append .btn {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
    }

    .pro-plan-thank-you {
        background-color: var(--primary-subtle);
        color: var(--primary-emphasis);
        padding: 1rem;
        border-radius: var(--border-radius-sm);
        margin-bottom: 1.5rem;
        text-align: center;
        font-weight: 500;
    }
    .pro-plan-thank-you i {
        margin-right: 0.5rem;
    }

    /* Ensure modal form groups have spacing */
    #changeEmailModal .modal-body .form-group {
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4 profile-container">
    <h1 class="mb-5 page-title text-center">My Profile</h1>

    {# Flash messages area #}
    {% include '_flash_messages.html' ignore missing %}

    {# --- Pro Plan Status Card --- #}
    <div class="card profile-card">
        <div class="card-header">
            <i class="bi bi-gem"></i> Pro Plan Status
        </div>
        <div class="card-body">
            {% if pro_plan_active %}
                <div class="pro-plan-thank-you">
                    <i class="bi bi-stars"></i> Thank you for being a Pro member!
                </div>
                <p>Your Pro Plan is currently <strong>Active</strong>.</p>
                {% if pro_plan_expiration_date %}
                    <p>Expires on: <strong>{{ pro_plan_expiration_date.strftime('%d.%m.%Y %H:%M') }} UTC</strong></p>
                {% else %}
                    <p class="text-warning">Expiration date not set. Please contact support.</p> {# Should not happen if plan is active #}
                {% endif %}
            {% else %}
                <p>You do not currently have the Pro Plan.</p>
                <a href="{{ url_for('main.subscribe') }}" class="btn btn-primary btn-sm mt-2">
                    <i class="bi bi-arrow-up-right-circle me-1"></i> Learn more & Upgrade to Pro
                </a>
            {% endif %}
        </div>
    </div>
    {# --- End Pro Plan Status Card --- #}

    {# --- Email Management Card --- #}
    <div class="card profile-card">
        <div class="card-header">
            <i class="bi bi-envelope-fill"></i> Email Address
        </div>
        <div class="card-body">
            <p>
                Current Email: <strong>{{ current_user.email | redact_email }}</strong>
            </p>
            <p>
                Status:
                {% if current_user.confirmed %}
                <span class="badge email-status email-status-verified">
                    <i class="bi bi-check-circle-fill me-1"></i>Verified
                </span>
                {% else %}
                <span class="badge email-status email-status-unverified">
                    <i class="bi bi-exclamation-triangle-fill me-1"></i>Not Verified
                </span>
                <a href="{{ url_for('auth.resend_confirmation') }}" class="btn btn-sm btn-outline-warning ms-2 py-1">Resend Confirmation</a>
                {% endif %}
            </p>
            <hr>
            <button type="button" class="btn btn-secondary btn-sm" data-toggle="modal" data-target="#changeEmailModal">
                <i class="bi bi-pencil-square me-1"></i> Change Email Address
            </button>
        </div>
    </div>
    {# --- End Email Management Card --- #}

    {# API Key Management Card #}
    <div class="card profile-card">
        <div class="card-header">
            <i class="bi bi-key-fill"></i> OBS Overlay API Key
        </div>
        <div class="card-body">
            <p class="text-secondary small mb-3">
                Used for the OBS overlay feature. This key allows you to connect your current challenge to OBS Studio.
                <br>
                <strong class="text-warning"><i class="bi bi-shield-exclamation me-1"></i>Keep this key private!</strong> Treat it like a password. If you suspect it's compromised, regenerate it immediately.
            </p>
            {% if current_user.overlay_api_key %}
            <label for="overlayApiKey" class="form-label small text-muted">Your Current Key:</label>
            <div class="input-group mb-3">
                <input type="password" class="form-control form-control-sm" id="overlayApiKey"
                    value="{{ current_user.overlay_api_key }}" readonly
                    title="Your overlay API key (click Show/Hide or Copy)">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary btn-sm" type="button" id="toggleApiKeyBtn"
                        title="Show/Hide Key"><i class="bi bi-eye-fill"></i></button>
                    <button class="btn btn-outline-secondary btn-sm" type="button" id="copyApiKeyBtn"
                        title="Copy Key"><i class="bi bi-clipboard me-1"></i> Copy</button>
                </div>
            </div>
            <form action="{{ url_for('profile.regenerate_overlay_key') }}" method="POST"
                onsubmit="return confirm('Are you sure you want to regenerate your key? Your existing overlay URL will stop working.');"
                class="d-inline-block">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-warning btn-sm"><i class="bi bi-arrow-repeat me-1"></i> Regenerate Key</button>
            </form>
            {% else %}
            <p>You haven't generated an overlay key yet.</p>
            <form action="{{ url_for('profile.regenerate_overlay_key') }}" method="POST" class="d-inline-block">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-success btn-sm"><i class="bi bi-plus-circle me-1"></i> Generate Key</button>
            </form>
            {% endif %}
        </div>
    </div>
    {# --- End API Key Management Card --- #}

    {# Account Security Card #}
    <div class="card profile-card">
        <div class="card-header">
            <i class="bi bi-shield-lock-fill"></i> Account Security
        </div>
        <div class="card-body">
            {% if not current_user.is_twitch_user %}
            <a href="{{ url_for('auth.change_password') }}" class="btn btn-secondary btn-sm me-2 mb-2">
                <i class="bi bi-lock-fill me-1"></i> Change Password
            </a>
            {% else %}
            <button class="btn btn-secondary btn-sm me-2 mb-2 disabled" title="Password managed via Twitch"
                aria-disabled="true"><i class="bi bi-lock-fill me-1"></i> Change Password</button>
            {% endif %}
            <a href="{{ url_for('auth.confirm_delete_account') }}" class="btn btn-danger btn-sm mb-2">
                <i class="bi bi-trash-fill me-1"></i> Delete Account
            </a>
        </div>
    </div>
    {# --- End Account Security Card --- #}

    {# --- Legal Information Card --- #}
    <div class="card profile-card">
        <div class="card-header">
            <i class="bi bi-file-earmark-text-fill"></i> Legal Information
        </div>
        <div class="card-body">
            <ul class="list-unstyled">
                <li><a href="{{ url_for('main.termsofservice') }}">Terms of Service</a></li>
                <li><a href="{{ url_for('main.datenschutz') }}">Privacy Policy (Datenschutz)</a></li>
                <li><a href="{{ url_for('main.impressum') }}">Impressum (Legal Notice)</a></li>
                <li><a href="{{ url_for('main.widerrufsbelehrung_de') }}">Widerrufsbelehrung (DE)</a></li>
                <li><a href="{{ url_for('main.widerrufsbelehrung_en') }}">Right of Withdrawal (EN)</a></li>
            </ul>
        </div>
    </div>
    {# --- End Legal Information Card --- #}

</div> {# End container #}

{# --- Change Email Modal (remains the same) --- #}
<div class="modal fade" id="changeEmailModal" tabindex="-1" role="dialog" aria-labelledby="changeEmailModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content"> {# Style handled by style.css #}
            <div class="modal-header">
                <h5 class="modal-title" id="changeEmailModalLabel">Change Email Address</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form method="POST" action="{{ url_for('profile.profile_view') }}" novalidate>
                {{ change_email_form.hidden_tag() }} {# Important for CSRF #}
                <div class="modal-body">
                    <p class="small text-secondary mb-3">
                        Enter your new email address and your current password. A confirmation link will be sent to the
                        new address.
                    </p>
                    {{ render_field(change_email_form.new_email, placeholder="New Email Address", autocomplete="email")
                    }}
                    {{ render_field(change_email_form.password, placeholder="Current Password",
                    autocomplete="current-password") }}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    {{ change_email_form.submit(class="btn btn-primary") }}
                </div>
            </form>
        </div>
    </div>
</div>
{# --- End Change Email Modal --- #}

{% endblock %}

{% block scripts %}
{{ super() }}
{# Script for API Key copy/toggle (remains the same) #}
<script>
    const copyBtn = document.getElementById('copyApiKeyBtn');
    const keyInput = document.getElementById('overlayApiKey');
    const showFlash = window.showFlash || function (msg, type) { console.log(`${type}: ${msg}`); };
    if (copyBtn && keyInput) { /* ... copy logic ... */
        copyBtn.addEventListener('click', () => {
            keyInput.select(); keyInput.setSelectionRange(0, 99999);
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(keyInput.value).then(() => { showFlash('API Key copied!', 'success'); }).catch(err => { console.error('Async: Could not copy text: ', err); showFlash('Failed to copy key (Clipboard API).', 'danger'); });
                } else { let successful = document.execCommand('copy'); if (successful) { showFlash('API Key copied! (fallback)', 'success'); } else { throw new Error('document.execCommand failed'); } }
            } catch (err) { console.error('Copy error:', err); showFlash('Failed to copy key.', 'danger'); }
            if (window.getSelection) { window.getSelection().removeAllRanges(); } else if (document.selection) { document.selection.empty(); }
        });
    }
    const toggleBtn = document.getElementById('toggleApiKeyBtn');
    if (toggleBtn && keyInput) { /* ... toggle logic ... */
        toggleBtn.addEventListener('click', () => {
            const currentType = keyInput.type;
            if (currentType === 'password') { keyInput.type = 'text'; toggleBtn.innerHTML = '<i class="bi bi-eye-slash-fill"></i>'; toggleBtn.title = 'Hide Key'; }
            else { keyInput.type = 'password'; toggleBtn.innerHTML = '<i class="bi bi-eye-fill"></i>'; toggleBtn.title = 'Show Key'; }
        });
    }
</script>
{# Optional: If validation fails on email change POST, re-open the modal #}
{% if change_email_form.errors %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        if (typeof $ !== 'undefined' && $.fn.modal) { $('#changeEmailModal').modal('show'); }
        else { /* Fallback for vanilla JS */ }
    });
</script>
{% endif %}
{% endblock %}
