{# app/templates/penalties.html #}

{% extends "base.html" %}
{% block title %}Penalties Configuration{% endblock %}
{% import "_form_helpers.html" as forms %} {# Import macros for modals #}

{% block head %}
    {{ super() }}
    {# Base style.css is linked in base.html #}
    <style> body { background-color: var(--base-bg, #030712); } </style>
{% endblock %}


{% block content %}
{# Added config-page-container class for CSS targeting #}
<div class="container mt-4 config-page-container">
  <h2 class="mb-4 page-title">Penalties Configuration</h2>
  <p class="text-secondary mb-4">Manage your penalty lists. Tabs are saved locally if not logged in. For logged-in users, changes are saved automatically. Double-click a tab name (except Default) to rename it locally.</p>

  {# --- Pass data to JavaScript --- #}
  <script>
    // Make login status and CSRF token globally available for JS modules
    const isLoggedIn = {{ current_user.is_authenticated| tojson }};
    const csrfToken = "{{ csrf_token() }}";

    // Assign to window object
    window.isLoggedIn = isLoggedIn;
    window.csrfToken = csrfToken;
  </script>
  {# --- End Data Passing --- #}

  {# --- Confirmation Modal for Loading Defaults (Penalty Specific) --- #}
  <div class="modal fade" id="confirmLoadDefaultPenaltiesModal" tabindex="-1" role="dialog" aria-labelledby="confirmLoadDefaultPenaltiesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content"> {# Style handled by style.css #}
        <div class="modal-header">
          <h5 class="modal-title" id="confirmLoadDefaultPenaltiesModalLabel">Load Default Penalties</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          {# Text updated dynamically by JS #}
          Load global defaults? This will override penalties currently in your local 'Default' tab.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" id="confirmLoadDefaultPenaltiesBtn" class="btn btn-primary">Yes, Load</button>
        </div>
      </div>
    </div>
  </div>
  {# --- End Confirmation Modal --- #}


  {# --- Top Button Row (Conditional on Login) --- #}
  {% if current_user.is_authenticated %}
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
      {# --- MODIFICATION START: Added btn-group and Duplicate Button --- #}
      <div class="btn-group mb-2" role="group" aria-label="Penalty Tab Actions">
          {# Autosave replaces manual save #}
          <button id="duplicatePenaltyTabBtn" class="btn btn-info btn-sm" title="Create a copy of the current tab">Duplicate Tab</button> {# ADDED Button #}
          <button id="deletePenaltyTabBtn" class="btn btn-danger btn-sm" >Delete Current Tab</button>
          {# Load Saved Tabs Button - We might remove this and load automatically #}
          {# <button id="loadSavedPenaltyTabsBtn" class="btn btn-info btn-sm mr-2 mb-2" >Load Saved Tabs</button> #}
      </div>
      {# --- MODIFICATION END --- #}
       <small class="text-secondary mb-2">Max 5 custom tabs allowed.</small> {# Use consistent limit text #}
    </div>
  {% endif %}
  {# --- End Top Button Row --- #}


  {# --- Tabs Navigation --- #}
  {# Use penalty-specific ID #}
  <ul class="nav nav-tabs mb-0" id="penaltiesTab" role="tablist"> {# style.css handles styling #}
    <li class="nav-item">
       {# Use penalty-specific ID #}
       <a class="nav-link active" id="default-penalty-tab" data-toggle="tab" href="#default" role="tab" aria-controls="default"
        aria-selected="true" title="This tab cannot be renamed or deleted.">Default</a>
    </li>
    {# JS inserts other tabs here #}
    <li class="nav-item">
      {# Use penalty-specific ID #}
      <a class="nav-link add-tab-button" href="#" id="addPenaltyTabBtn" role="tab" title="Add New Penalty Tab">+</a>
    </li>
    {# Loading Placeholder (inserted by JS if needed, but can be static) #}
    <li id="loadingPenaltyTabsPlaceholder" class="nav-item ms-2 align-self-center text-secondary small" style="display: none;">
      <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Loading Tabs...
    </li>
  </ul>
  {# --- End Tabs Navigation --- #}


  {# --- Tab Content --- #}
  {# Use penalty-specific ID #}
  <div class="tab-content" id="penaltiesTabContent"> {# style.css handles border/padding/bg #}
    {# Default Tab Pane (ID must match link href) #}
    <div class="tab-pane fade show active" id="default" role="tabpanel" aria-labelledby="default-penalty-tab">
       {# Action buttons within tab #}
       <div class="d-flex justify-content-start my-3 flex-wrap gap-2"> {# Added flex-wrap and gap #}
           {# Use penalty-specific ID #}
           <button id="loadDefaultPenaltiesBtn" class="btn btn-warning" title="Load default penalties from the database into this local tab">Load Global Defaults</button>
           {# Use penalty-specific class and data-tab #}
           <button class="btn btn-primary insertPenaltyBtn" data-tab="default" title="Add a new penalty to this tab">Insert New Penalty</button>
       </div>
       {# Include table structure #}
       {% include "penalties/penalties_table.html" %}
    </div>
     {# JS inserts other tab panes here #}
  </div>
  {# --- End Tab Content --- #}


  {# Include Modals #}
  {% include "penalties/penalties_modals.html" %} {# Includes New/Edit Modals #}
  {# General Action Confirmation Modal (from form helpers) #}
  {{ forms.confirm_action_modal(modal_id='actionConfirmModal', title_id='actionConfirmTitle', body_id='actionConfirmBody', ok_id='actionConfirmOk') }}
  {# Rename Tab Modal (from form helpers, specify context) #}
  {{ forms.rename_tab_modal('penalty') }}

</div> {# End Container #}
{% endblock %}


{% block scripts %}
{{ super() }}
{# --- Load Penalty JS Modules --- #}
<script type="module" src="{{ url_for('static', filename='js/utils/api.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/utils/helpers.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/penalties/penaltyLocalStorageUtils.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/penalties/penaltyTabManagement.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/penalties/penaltyEntryManagement.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/penalties/penaltyExtensions.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/penalties/penalties.js') }}"></script> {# Main orchestrator #}
{% endblock %}
