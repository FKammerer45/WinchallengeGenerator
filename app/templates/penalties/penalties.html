{# app/templates/penalties/penalties.html #}

{% extends "base.html" %}
{% block title %}Penalties Configuration{% endblock %}
{% import "_form_helpers.html" as forms %} {# Ensure this path is correct #}

{% block head %}
    {{ super() }}
    {# Ensure Bootstrap Icons are linked in base.html or link them here if not already #}
    {# <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"> #}
    <style>
        body { 
            background-color: var(--base-bg, #030712); /* Dark background */
            color: var(--text-primary, #e0e0e0); /* Light text */
        }
        .config-page-container .page-title {
            color: var(--text-accent, #67a3ff); /* Accent color for title */
            font-weight: 600;
        }
        .config-page-container .text-secondary {
            color: var(--text-secondary, #adb5bd) !important; /* Softer secondary text */
        }
        .nav-tabs {
            border-bottom-color: var(--surface-border-light, #495057);
        }
        .nav-tabs .nav-link {
            border-color: var(--surface-border, #343a40);
            color: var(--text-secondary, #adb5bd);
            border-bottom-width: 0; 
            margin-right: 2px; 
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            border-radius: var(--border-radius-sm, 0.25rem) var(--border-radius-sm, 0.25rem) 0 0 !important;
        }
        .nav-tabs .nav-link:hover:not(.active) {
            background-color: var(--surface-highlight, rgba(255,255,255,0.05));
            border-color: var(--surface-border, #495057);
            color: var(--text-primary, #e0e0e0);
        }
        .nav-tabs .nav-link.active {
            background-color: var(--surface-card, #1f2937); 
            color: var(--text-accent, #67a3ff);
            border-color: var(--surface-border, #343a40);
            border-bottom-color: transparent; 
            font-weight: 500;
        }
        .tab-content {
            background-color: var(--surface-card, #1f2937); 
            border: 1px solid var(--surface-border, #343a40);
            border-top: none; 
            padding: 1.5rem; 
            border-radius: 0 0 var(--border-radius, 0.375rem) var(--border-radius, 0.375rem);
        }
        .action-button-row {
            padding-bottom: 1rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--surface-border-light, #495057);
        }
        .action-button-row .btn {
            margin-right: 0.5rem; 
        }
        .action-button-row .btn i {
            margin-right: 0.35rem;
        }
        .add-tab-button { 
            font-size: 1.1rem;
            padding: 0.5rem 0.8rem; 
        }
        .add-tab-button:hover i {
            color: var(--text-accent-hover, #8bbaff);
        }
        .loading-placeholder-text { 
            color: var(--text-secondary);
        }
        .config-table th {
             background-color: var(--surface-header, rgba(255, 255, 255, 0.05)); 
        }
        /* Styles for tab grouping (same as games.html) */
        .tabs-separator {
            height: 1px;
            background-color: var(--surface-border-light, #495057);
            margin: 0.5rem 0.75rem;
            flex-grow: 0;
            width: auto;
            align-self: stretch;
            display: none;
            list-style-type: none;
        }
        .tabs-spacer { /* Using spacer for penalties as well */
            width: 10px; 
            display: none; 
            list-style-type: none;
        }
        .nav-tabs .nav-item.system-default-group-label,
        .nav-tabs .nav-item.custom-group-label {
            align-self: center;
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
            color: var(--text-muted, #6c757d);
            font-style: italic;
            display: none;
        }
    </style>
{% endblock %}


{% block content %}
<div class="container mt-4 mb-5 config-page-container">
  <header class="mb-4 text-center">
    <h2 class="page-title"><i class="bi bi-shield-exclamation me-2"></i>Penalties Configuration</h2>
    <p class="text-secondary lead fs-6">
      Define and organize penalties for your challenges.
    </p>
  </header>

  {# --- Pass data to JavaScript --- #}
  <script>
    const isLoggedIn = {{ current_user.is_authenticated| tojson }};
    const csrfToken = "{{ csrf_token() }}";
    window.isLoggedIn = isLoggedIn;
    window.csrfToken = csrfToken;
    window.SYSTEM_DEFAULT_PENALTY_TABS = {}; // For penalties
  </script>

  {# --- Top Button Row (Conditional on Login) --- #}
  {% if current_user.is_authenticated %}
  <div class="d-flex justify-content-between align-items-center mb-3 action-button-row">
      <div class="btn-group" role="group" aria-label="Penalty Tab Actions">
          <button id="duplicatePenaltyTabBtn" class="btn btn-outline-info btn-sm" title="Create a copy of the current penalty tab">
              <i class="bi bi-front"></i>Duplicate Tab
          </button>
          <button id="deletePenaltyTabBtn" class="btn btn-outline-danger btn-sm" title="Delete the currently active custom penalty tab">
              <i class="bi bi-trash3"></i>Delete Current Tab
          </button>
      </div>
      <small class="text-secondary">Max 5 custom tabs allowed (excluding system defaults).</small>
  </div>
  {% endif %}
  {# --- End Top Button Row --- #}


  {# --- Tabs Navigation --- #}
  <ul class="nav nav-tabs mb-0 d-flex flex-wrap" id="penaltiesTab" role="tablist">
    {# JS will insert system default tabs, separator, custom tabs, and manage add button & loading #}
    <li class="nav-item system-default-group-label" id="systemPenaltyTabsLabel">Default Penalty Sets</li>
    
    <li class="tabs-spacer" id="customPenaltyTabsSeparator"></li> 
    
    <li class="nav-item custom-group-label" id="customPenaltyTabsLabel">Your Custom Penalty Sets</li>

    <li class="nav-item ms-auto order-last">
      <a class="nav-link add-tab-button" href="#" id="addPenaltyTabBtn" role="tab" title="Add New Custom Penalty Tab"
         style="border-radius: var(--border-radius-sm, 0.25rem) var(--border-radius-sm, 0.25rem) 0 0;">
        <i class="bi bi-plus-lg"></i> 
      </a>
    </li>
    <li id="loadingPenaltyTabsPlaceholder" class="nav-item align-self-center order-last" style="display: none;">
      <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
      <span class="loading-placeholder-text small">Loading Tabs...</span>
    </li>
  </ul>
  {# --- End Tabs Navigation --- #}


  {# --- Tab Content --- #}
  <div class="tab-content" id="penaltiesTabContent">
    {# JS will insert tab panes here #}
  </div>
  {# --- End Tab Content --- #}

  {# Modals and Confirmation #}
  {{ forms.confirm_action_modal(modal_id='actionConfirmModal', title_id='actionConfirmTitle', body_id='actionConfirmBody', ok_id='actionConfirmOk') }}
  {% include "penalties/penalties_modals.html" %} {# This will be overhauled next #}
  {{ forms.rename_tab_modal('penalty') }} {# For renaming penalty tabs #}

</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    {# Ensure these script paths are correct and files exist #}
    <script type="module" src="{{ url_for('static', filename='js/utils/api.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/utils/helpers.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/penalties/penaltyLocalStorageUtils.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/penalties/penaltyTabManagement.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/penalties/penaltyEntryManagement.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/penalties/penaltyExtensions.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/penalties/penalties.js') }}"></script>
{% endblock %}
