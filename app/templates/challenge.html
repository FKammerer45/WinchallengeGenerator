{% extends "base.html" %}

{# --- Set Title Dynamically --- #}
{% block title %}
{% if is_local %}
Local Challenge View
{% elif shared_challenge %}
Challenge: {{ shared_challenge.name or shared_challenge.public_id }}
{% else %}
Challenge Not Found
{% endif %}
{% endblock %}

{% block head %}
{{ super() }}
{# Base style.css is linked in base.html #}
{% endblock %}


{% block content %}
{# Add page-specific class and mode class #}
{% set body_class = 'single-group-mode' if not is_multigroup else 'multi-group-mode' %}
<div class="container mt-4 challenge-view-page {{ body_class }}">

  {# --- Hidden Data Div for JavaScript --- #}
  {% if is_local or shared_challenge %}
  <div id="challengeData" style="display: none;" aria-hidden="true" data-challenge-id="{{ challenge_id }}"
    data-is-local="{{ is_local | lower }}" data-is-multigroup="{{ is_multigroup | lower }}"
    data-is-logged-in="{{ current_user.is_authenticated | lower }}" data-csrf-token="{{ csrf_token() }}"
    data-user-joined-group-id="{{ user_joined_group_id | tojson }}"
    data-add-group-url="{{ url_for('challenge_api.add_group_to_challenge', public_id=challenge_id) if not is_local else '' }}"
    data-update-progress-url-base="{{ url_for('challenge_api.update_group_progress', public_id=challenge_id, group_id=0) | replace('/0/progress', '') if not is_local else '' }}"
    data-join-leave-url-base="{{ url_for('challenge_api.join_group', group_id=0) | replace('/groups/0/join', '/groups') if not is_local else '' }}"
    data-save-players-url-base="{{ url_for('challenge_api.join_group', group_id=0) | replace('/groups/0/join', '/groups') if not is_local else '' }}"
    data-set-penalty-url-base="{{ url_for('challenge_api.set_group_penalty', group_id=0) | replace('/groups/0/penalty', '/groups') if not is_local else '' }}"
    data-num-players-per-group="{{ num_players_per_group | default(1) }}"
    data-initial-groups='{{ initial_groups | tojson if initial_groups else "null" }}'
    data-challenge-json='{{ shared_challenge.challenge_data | tojson if shared_challenge else "null" }}'
    data-penalty-info='{{ shared_challenge.penalty_info | tojson if shared_challenge and shared_challenge.penalty_info else "null" }}'
    data-max-groups="{{ shared_challenge.max_groups if shared_challenge else 1 }}"
    data-authorize-user-url="{{ url_for('challenge_api.add_authorized_user', public_id=challenge_id) if not is_local else '' }}"
    data-remove-user-url-base="{{ url_for('challenge_api.remove_authorized_user', public_id=challenge_id, user_id=0) | replace('/0', '') if not is_local else '' }}"
    data-is-creator="{{ is_creator | lower }}"
    data-is-authorized="{{ is_authorized | lower }}">
  </div>
  {% endif %}
  {# --- End Data Div --- #}


  {# --- Main Content Area Container --- #}
  <div id="challengeViewContainer">

    {# General status message area - ALWAYS RENDERED #}
    <div id="pageStatusDisplay" class="mb-4"></div>

    {% if is_local %}
    {# --- Local Challenge View (Rendered entirely by JS) --- #}
    <div id="localChallengeDisplay">
      <h1 class="text-center text-secondary">Loading Local Challenge...</h1>
      <div class="d-flex justify-content-center mt-3">
        <div class="spinner-border text-light" role="status"><span class="sr-only">Loading...</span></div>
      </div>
    </div>

    {% elif shared_challenge %}
    {# --- Database Challenge View --- #}

    {# Row for Challenge Info and Rules Cards #}
    <div class="row mb-5">
      <div class="col-lg-5 mb-4 mb-lg-0"> {# Info Card #}
        {# Apply glass effect #}
        <div class="card h-100 shadow-md info-card glass-effect">
          <div class="card-header">
            <h3 class="h5 mb-0">Challenge Info</h3>
          </div>
          <div class="card-body">
            <h4 class="card-title text-secondary-accent">{{ shared_challenge.name or "Unnamed Shared Challenge" }}</h4>
            {# Use secondary accent #}
            <p class="card-text small mb-1"><strong class="text-secondary">ID:</strong> <code
                class="user-select-all">{{ shared_challenge.public_id }}</code></p>
            <p class="card-text small mb-1"><strong class="text-secondary">Created by:</strong> {{
              shared_challenge.creator.username if shared_challenge.creator else "Unknown" }}</p>
            <p class="card-text small mb-3"><strong class="text-secondary">Mode:</strong> {% if is_multigroup
              %}Multigroup (Max {{ shared_challenge.max_groups }}) | Players/Group: {{ num_players_per_group }}{% else
              %}Single Group{% endif %}</p>
            <p class="card-text small font-italic text-secondary">{% if is_multigroup %}Share URL to join!{% else
              %}Track progress below.{% endif %}</p>
          </div>
        </div>
      </div>
      <div class="col-lg-7"> {# Rules Card #}
        {# Apply glass effect #}
        <div class="card h-100 shadow-md rules-card glass-effect">
          <div class="card-header">
            <h3 class="h5 mb-0">Challenge Rules</h3>
          </div>
          <div class="card-body challenge-rules-list">
            {% set c = shared_challenge.challenge_data %}
            {% include 'challenge/_challenge_details.html' ignore missing %}
          </div>
        </div>
      </div>
    </div>
    {% if is_creator %}
    <hr class="my-5"> {# Optional separator #}
    <div class="card shadow-md mb-5 management-card glass-effect"> {# Added glass-effect #}
      <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="h5 mb-0">Manage Authorized Users</h3>
        <button class="btn btn-sm btn-outline-secondary" type="button" data-toggle="collapse"
          data-target="#manageUsersBody" aria-expanded="false" aria-controls="manageUsersBody"
          title="Toggle User Management">
          <i class="bi bi-chevron-expand"></i> {# Use Bootstrap Icons #}
        </button>
      </div>
      <div class="collapse" id="manageUsersBody"> {# Start collapsed? Or use 'show' class #}
        <div class="card-body">
          <p class="small text-secondary">Users added here (besides yourself) can join/leave groups, update
            progress/players in groups they join, and use the penalty wheel.</p>
          <div id="manageUsersError" class="text-danger small mb-2"></div> {# Error display area #}

          {# Form for adding users #}
          <div class="input-group mb-3">
            <input type="text" id="addUsernameInput" class="form-control form-control-sm"
              placeholder="Enter username to authorize">
            <div class="input-group-append">
              <button class="btn btn-sm btn-outline-success" type="button" id="authorizeUserBtn">
                <span class="spinner-border spinner-border-sm" style="display: none;"></span>
                <span>Authorize</span>
              </button>
            </div>
          </div>

          {# List of authorized users #}
          <h6 class="mt-4 mb-2 small text-uppercase text-secondary">Currently Authorized:</h6>
          <ul id="authorizedUsersList" class="list-group list-group-flush">
            {% if authorized_user_list %}
            {% for auth_user in authorized_user_list %}
            {# Don't list the creator themselves for removal #}
            {% if auth_user.id != shared_challenge.creator_id %}
            <li
              class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-1 px-2 authorized-user-item"
              data-user-id="{{ auth_user.id }}">
              <span class="username">{{ auth_user.username | escape }}</span>
              <button class="btn btn-xs btn-outline-danger remove-auth-user-btn" data-user-id="{{ auth_user.id }}"
                data-username="{{ auth_user.username | escape }}" title="Remove Authorization">
                <span class="spinner-border spinner-border-sm" style="display: none;"></span>
                <span>&times;</span> {# Simple remove icon #}
              </button>
            </li>
            {% endif %}
            {% endfor %}
            {% if authorized_user_list | length == 1 and authorized_user_list[0].id == shared_challenge.creator_id %}
            <li class="list-group-item list-group-item-action py-1 px-2 text-muted small">(Only you)</li>
            {% endif %}
            {% else %}
            <li class="list-group-item list-group-item-action py-1 px-2 text-muted small">(Only you)</li>
            {% endif %}
          </ul>
        </div> {# End card-body #}
      </div> {# End collapse #}
    </div> {# End card #}
    {% endif %} {# End if is_creator #}

    {# Penalty Section (Conditional) #}
    {% if shared_challenge.penalty_info %}
    {# Use standard opaque card for better contrast with wheels? Or glass? Let's try standard. #}
    <div id="penaltySectionContainer" class="mb-5 card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="h5 mb-0">Penalties</h3>
        <button class="btn btn-sm btn-outline-secondary" type="button" data-toggle="collapse" data-target="#penaltyBody"
          aria-expanded="true" aria-controls="penaltyBody" title="Toggle Penalty Section">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
            class="bi bi-chevron-expand" viewBox="0 0 16 16">
            <path fill-rule="evenodd"
              d="M3.646 9.146a.5.5 0 0 1 .708 0L8 12.793l3.646-3.647a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 0-.708m0-2.292a.5.5 0 0 0 .708 0L8 3.207l3.646 3.647a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 0 0 0 .708" />
          </svg>
        </button>
      </div>
      <div class="card-body collapse show" id="penaltyBody">
        {% set p_info = shared_challenge.penalty_info %}
        {% set players = [] %}
        {% set penalty_tab_id = p_info.get('tab_id') %}
        {% set challenge_index = 'shared' %}
        {% include 'challenge/_challenge_penalty_section.html' ignore missing %}
      </div>
    </div>
    {% endif %}

    {# --- Group Management & Display Section --- #}
    <hr class="my-5">
    <h2 class="mb-4 text-light text-center">{% if is_multigroup %}Groups & Progress{% else %}Your Progress{% endif %}
    </h2>

    {# Create Group Form (Only for Multigroup) #}
    {% if not is_local %}
    {% if is_creator %}
    {# Use standard opaque card for form readability #}
    <div class="mb-5 card shadow-md">
      <div class="card-body p-4">
        <h4 class="card-title text-secondary-accent text-center mb-4">Create or Join Group</h4> {# Pink accent #}
        <form id="addGroupForm" class="form" novalidate>
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="form-row align-items-center justify-content-center">
            <div class="col-sm-7 col-md-7 mb-2 mb-sm-0">
              <label for="groupNameInput" class="sr-only">Group Name</label>
              <input type="text" class="form-control form-control-lg" {# Styled by style.css #} id="groupNameInput"
                name="group_name" placeholder="Enter group name to create" required maxlength="80">
            </div>
            <div class="col-sm-4 col-md-3">
              {# Use success (green) button #}
              <button type="submit" id="addGroupBtn" class="btn btn-success btn-lg btn-block">
                <span class="spinner-border spinner-border-sm" style="display: none;"></span>
                <span>Create Group</span>
              </button>
            </div>
          </div>
          <div class="text-center">
            <small id="groupLimitInfo" class="form-text text-secondary mt-2">Groups: <span id="currentGroupCount">{{
                initial_groups | length }}</span> / <span id="maxGroupCount">{{ shared_challenge.max_groups
                }}</span></small>
          </div>
        </form>
        <div id="addGroupError" class="text-danger mt-2 font-weight-bold text-center" style="display: none;"></div>
      </div>
    </div>
    {% endif %}
    {% endif %}

    {# --- "Your Group" Section Container --- #}
    <div id="myGroupContainer" class="mb-5">
      {% if not is_local and user_joined_group_id is not none %}
      <h4 class="text-primary-accent mb-3 text-center">Your Group</h4> {# Blue accent #}
      {% for group_data in initial_groups if group_data.id == user_joined_group_id %}
      {# Include the partial, passing context #}
      {% with group=group_data, challenge=shared_challenge, is_member=True, is_multigroup=is_multigroup,
      num_players_per_group=num_players_per_group %}
      {% include 'challenge/_group_card_content.html' ignore missing %}
      {% endwith %}
      {% endfor %}
      <hr class="mt-5"> {# Separator after "Your Group" #}
      {% endif %}
    </div>
    {# --- End "Your Group" Section --- #}


    {# --- "Other Groups" Section --- #}
    <h4 class="text-primary-accent mb-4 text-center {% if not is_multigroup %}d-none{% endif %}"> {# Blue accent #}
      {% if user_joined_group_id is none %}Available Groups{% else %}Other Available Groups{% endif %}
    </h4>
    <div id="otherGroupsContainer" class="row justify-content-center">
      {% if not is_local and initial_groups %}
      {% for group_data in initial_groups if group_data.id != user_joined_group_id %}
      {# Include the partial, passing context #}
      {% with group=group_data, challenge=shared_challenge, is_member=False, is_multigroup=is_multigroup,
      num_players_per_group=num_players_per_group %}
      {% include 'challenge/_group_card_content.html' ignore missing %}
      {% endwith %}
      {% endfor %}
      {% endif %}
    </div>
    {# --- End "Other Groups" Section --- #}

    {# Message shown if no groups exist #}
    <div id="noGroupsMessageContainer" class="col-12 {% if initial_groups %}d-none{% endif %}">
      <p class="text-secondary text-center py-5">No groups available.{% if not is_local %} Create one above!{% endif %}
      </p>
    </div>

    {% else %} {# Error loading challenge #}
    {% if not is_local %}
    <div class="alert alert-danger glass-effect">Error: Challenge details could not be loaded.</div>
    {% endif %}
    {% endif %} {# End if is_local / elif shared_challenge #}

  </div> {# End challengeViewContainer #}
</div> {# End container #}

{# --- Template for New Group Cards (Used by JS) --- #}
{% if not is_local %}
<template id="groupCardTemplate">
  {# Apply standard column classes here #}
  <div class="col-lg-4 col-md-6 mb-4 group-card-wrapper" data-group-id="">
    {# Add glass-effect class to the card created by JS #}
    <div class="card group-card h-100 glass-effect">
      <div class="card-body">
        <h5 class="card-title"></h5> {# JS sets name #}
        <div id="progressBarContainer-" class="group-progress-bar-container mb-3"> {# Placeholder for progress bar #}
        </div>
        <div class="group-progress-container">
          <p class="text-secondary small">Loading progress...</p> {# Placeholder #}
        </div>
        <div class="player-names-section mt-3 border-top pt-3" style="display: none;">
          <h6 class="small mb-2">Group Players (Max {{ num_players_per_group | default(1) }}):</h6>
          <div class="player-name-inputs"></div>
          <div class="player-name-error text-danger small mt-1"></div>
        </div>
        <div class="active-penalty-display mt-2 border-top pt-2 mx-0 mb-2" data-group-id="" style="display: none;"> {#
          Adjusted margin/padding #}
          <h6 class="small mb-1">Active Penalty:</h6>
          <p class="mb-0 small penalty-text-content"></p>
        </div>
      </div>
      <div class="card-footer text-center join-leave-footer"></div> {# Footer for JS buttons #}
    </div>
  </div>
</template>
{% endif %}
{# --- End Template --- #}

{% endblock %}


{% block scripts %}
{{ super() }} {# Include base scripts (jQuery, Bootstrap) #}

{# --- Conditionally Load Penalty-Related Scripts --- #}

<script src="{{ url_for('static', filename='js/libs/Winwheel.min.js') }}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenMax.min.js"></script>
<script type="module" src="{{ url_for('static', filename='js/penalties/penaltyLocalStorageUtils.js') }}"></script>


{# --- Core Challenge View Modules --- #}
<script type="module" src="{{ url_for('static', filename='js/utils/helpers.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/utils/api.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/utils/local_storage.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/challenge_view/ui.js') }}"></script>



{# --- Main View Orchestrator Module --- #}
<script type="module" src="{{ url_for('static', filename='js/challenge_view/main.js') }}"></script>
{% endblock %}