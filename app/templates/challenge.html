{% extends "base.html" %}

{# --- Set Title Dynamically --- #}
{% block title %}
{% if is_local %}
Local Challenge View
{% elif shared_challenge %}
Challenge: {{ shared_challenge.name or shared_challenge.public_id }}
{% else %}
Challenge Not Found
{% endif %}
{% endblock %}

{% block head %}
{{ super() }}
{% endblock %}


{% block content %}
{# Add body class based on mode for potential CSS targeting #}
{% set body_class = 'single-group-mode' if not is_multigroup else 'multi-group-mode' %}
<div class="container mt-4 {{ body_class }}">

  {# --- Hidden Data Div for JavaScript --- #}
  {% if is_local or shared_challenge %}
  <div id="challengeData" style="display: none;" aria-hidden="true"
       data-challenge-id="{{ challenge_id }}"
       data-is-local="{{ is_local | lower }}"
       data-is-multigroup="{{ is_multigroup | lower }}"
       data-is-logged-in="{{ current_user.is_authenticated | lower }}"
       data-csrf-token="{{ csrf_token() }}"
       data-user-joined-group-id="{{ user_joined_group_id | tojson }}"
       data-add-group-url="{{ url_for('challenge_api.add_group_to_challenge', public_id=challenge_id) if not is_local else '' }}"
       data-update-progress-url-base="{{ url_for('challenge_api.update_group_progress', public_id=challenge_id, group_id=0) | replace('/0/progress', '') if not is_local else '' }}"
       data-join-leave-url-base="{{ url_for('challenge_api.join_group', group_id=0) | replace('/groups/0/join', '/groups') if not is_local else '' }}"
       data-save-players-url-base="{{ url_for('challenge_api.join_group', group_id=0) | replace('/groups/0/join', '/groups') if not is_local else '' }}"
       data-set-penalty-url-base="{{ url_for('challenge_api.set_group_penalty', group_id=0) | replace('/groups/0/penalty', '/groups') if not is_local else '' }}"
       data-num-players-per-group="{{ num_players_per_group | default(1) }}"
       data-initial-groups='{{ initial_groups | tojson if initial_groups else "null" }}'
       data-challenge-json='{{ shared_challenge.challenge_data | tojson if shared_challenge else "null" }}'
       data-penalty-info='{{ shared_challenge.penalty_info | tojson if shared_challenge and shared_challenge.penalty_info else "null" }}'
       data-max-groups="{{ shared_challenge.max_groups if shared_challenge else 1 }}">
  </div>
  {% endif %}
  {# --- End Data Div --- #}


  {# --- Main Content Area Container --- #}
  <div id="challengeViewContainer">

    {# General status message area - ALWAYS RENDERED #}
    <div id="pageStatusDisplay" class="mb-3"></div>

    {# --- *** FIX: Corrected include syntax for timer *** --- #}
    {% with timer_id='main' %}
      {% include 'challenge/_challenge_timer.html' ignore missing %}
    {% endwith %}
    {# --- *** END FIX *** --- #}

    {% if is_local %}
    {# --- Local Challenge View (Rendered entirely by JS) --- #}
    <div id="localChallengeDisplay">
      <h1 class="text-center text-muted">Loading Local Challenge...</h1>
      <div class="d-flex justify-content-center mt-3">
        <div class="spinner-border text-light" role="status"><span class="sr-only">Loading...</span></div>
      </div>
    </div>

    {% elif shared_challenge %}
    {# --- Database Challenge View --- #}

    {# Row for Challenge Info and Rules Cards #}
    <div class="row mb-4">
      <div class="col-lg-5 mb-4 mb-lg-0"> {# Info Card Column #}
        <div class="card h-100 bg-dark text-light shadow-sm challenge-info-card">
          <div class="card-header"><h3 class="h5 mb-0">Challenge Info</h3></div>
          <div class="card-body d-flex flex-column">
            <h4 class="card-title text-warning mb-3">{{ shared_challenge.name or "Unnamed Shared Challenge" }}</h4>
            <p class="card-text mb-2">
              <strong class="text-muted" style="min-width: 80px; display: inline-block;">Mode:</strong>
              {% if is_multigroup %}
                Multigroup (Max {{ shared_challenge.max_groups }}) | {{ num_players_per_group }} Player{{ 's' if num_players_per_group != 1 else '' }}/Group
              {% else %}
                Single Group
              {% endif %}
            </p>
            <p class="card-text mb-auto">
              <strong class="text-muted" style="min-width: 80px; display: inline-block;">Creator:</strong>
              {{ shared_challenge.creator.username if shared_challenge.creator else "Unknown" }}
            </p>
            <div class="mt-3 pt-3 border-top border-secondary">
                <p class="card-text small mb-0">
                  <strong class="text-muted">ID:</strong>
                  <code class="user-select-all bg-secondary p-1 rounded" style="font-size: 0.9em;">{{ shared_challenge.public_id }}</code>
                </p>
                {% if is_multigroup %}
                <p class="card-text small mt-1">
                    <a href="{{ request.url }}" class="text-info">Copy Share Link</a>
                </p>
                {% endif %}
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-7"> {# Rules Card Column #}
        <div class="card h-100 bg-dark text-light shadow-sm challenge-rules-card">
          <div class="card-header"><h3 class="h5 mb-0">Challenge Rules</h3></div>
          <div class="card-body challenge-rules-body">
            {% set c = shared_challenge.challenge_data %}
            {% include 'challenge/_challenge_details.html' ignore missing %}
          </div>
        </div>
      </div>
    </div>

    {# Penalty Section (Conditional) #}
    {% if shared_challenge.penalty_info %}
    <div id="penaltySectionContainer" class="mb-4 card bg-secondary text-light">
      <div class="card-header">
        <h3 class="mb-0 d-inline">Penalties</h3>
        <button class="btn btn-sm btn-outline-light float-right" type="button" data-toggle="collapse"
                data-target="#penaltyBody" aria-expanded="true" aria-controls="penaltyBody">
          Toggle View
        </button>
      </div>
      <div class="card-body collapse show" id="penaltyBody">
        {% set p_info = shared_challenge.penalty_info %}
        {% set players = [] %}
        {% set penalty_tab_id = p_info.get('tab_id') %}
        {% set challenge_index = 'shared' %}
        {% include 'challenge/_challenge_penalty_section.html' ignore missing %}
      </div>
    </div>
    {% endif %}

    {# --- Group Management & Display Section --- #}
    <hr class="my-4 border-secondary">
    <h2 class="mb-3 text-light">{% if is_multigroup %}Groups & Progress{% else %}Your Progress{% endif %}</h2>

    {# Create Group Form (Only for Multigroup) #}
    {% if is_multigroup %}
    <div class="mb-4 card bg-dark border-secondary text-light">
      <div class="card-body">
        <h4 class="card-title text-warning">Create or Join Group</h4>
        <form id="addGroupForm" class="form" novalidate>
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="form-row align-items-center">
            <div class="col-sm-8 col-md-9 mb-2 mb-sm-0">
              <label for="groupNameInput" class="sr-only">Group Name</label>
              <input type="text" class="form-control form-control-lg bg-secondary text-light border-secondary"
                     id="groupNameInput" name="group_name" placeholder="Enter group name to create" required maxlength="80">
            </div>
            <div class="col-sm-4 col-md-3">
              <button type="submit" id="addGroupBtn" class="btn btn-success btn-lg btn-block">
                <span class="spinner-border spinner-border-sm" style="display: none;"></span>
                <span>Create Group</span>
              </button>
            </div>
          </div>
          <small id="groupLimitInfo" class="form-text text-muted mt-2">Groups: <span id="currentGroupCount">{{ initial_groups | length }}</span> / <span id="maxGroupCount">{{ shared_challenge.max_groups }}</span></small>
        </form>
        <div id="addGroupError" class="text-danger mt-2 font-weight-bold" style="display: none;"></div>
      </div>
    </div>
    {% endif %}

    {# --- "Your Group" Section Container --- #}
    <div id="myGroupContainer" class="mb-4">
      {% if not is_local and user_joined_group_id is not none %}
        <h4 class="text-warning mb-3">Your Group</h4>
        {% for group_data in initial_groups if group_data.id == user_joined_group_id %}
          {# Include the group card partial, passing context #}
          {% with group=group_data, challenge=shared_challenge, is_member=True, is_multigroup=is_multigroup, num_players_per_group=num_players_per_group %}
            {% include 'challenge/_group_card_content.html' ignore missing %}
          {% endwith %}
        {% endfor %}
        <hr class="border-secondary"> {# Separator after "Your Group" #}
      {% endif %}
    </div>
    {# --- End "Your Group" Section --- #}


    {# --- "Other Groups" Section --- #}
    <h4 class="text-info mb-3 {% if not is_multigroup %}d-none{% endif %}">
      {% if user_joined_group_id is none %}Available Groups{% else %}Other Available Groups{% endif %}
    </h4>
    <div id="otherGroupsContainer" class="row justify-content-center">
      {% if not is_local and initial_groups %}
        {% for group_data in initial_groups if group_data.id != user_joined_group_id %}
           {# Include the group card partial, passing context #}
           {% with group=group_data, challenge=shared_challenge, is_member=False, is_multigroup=is_multigroup, num_players_per_group=num_players_per_group %}
             {% include 'challenge/_group_card_content.html' ignore missing %}
           {% endwith %}
        {% endfor %}
      {% endif %}
      {# Message shown if no other groups exist #}
      {% if not is_local and initial_groups and (initial_groups | rejectattr('id', 'equalto', user_joined_group_id) | list | length == 0) %}
         <div class="col-12">
             <p class="text-light text-center py-3">No other groups available.</p>
         </div>
      {% endif %}
    </div>
    {# --- End "Other Groups" Section --- #}

    {# Message shown if no groups exist at all (JS manages visibility) #}
    <div id="noGroupsMessageContainer" class="col-12 {% if initial_groups %}d-none{% endif %}">
      <p class="text-muted text-center py-5">No groups yet.{% if is_multigroup %} Create one above!{% endif %}</p>
    </div>

    {% else %} {# Error loading challenge #}
      {% if not is_local %}
        <div class="alert alert-danger">Error: Challenge details could not be loaded.</div>
      {% endif %}
    {% endif %} {# End if is_local / elif shared_challenge #}

  </div> {# End challengeViewContainer #}
</div> {# End container #}

{# --- Template for New Group Cards (Used by JS) --- #}
{% if is_multigroup %}
<template id="groupCardTemplate">
  <div class="col-lg-4 col-md-6 mb-4 group-card-wrapper" data-group-id="">
    <div class="card group-card h-100">
      <div class="card-body">
        <h5 class="card-title"></h5> {# JS sets name #}
        <div id="progressBarContainer-" class="group-progress-bar-container mb-3"> {# ID will be completed by JS #}
            {# JS will render the progress bar here #}
        </div>
        <div class="group-progress-container">
          <p class="text-muted small">Loading progress...</p> {# Placeholder #}
        </div>
        {# Placeholder for Player Names section #}
        <div class="player-names-section mt-3 border-top border-secondary pt-3" style="display: none;">
          <h6 class="text-light small mb-2">Group Players (Max {{ num_players_per_group | default(1) }}):</h6>
          <div class="player-name-inputs"></div> {# JS renders inputs here #}
          <div class="player-name-error text-danger small mt-1"></div> {# JS shows errors here #}
          {# JS adds save button here #}
        </div>
         {# Placeholder for Active Penalty display #}
        <div class="active-penalty-display mt-2 border-top border-secondary pt-2 mx-3 mb-2" data-group-id="" style="display: none;">
             <h6 class="text-danger small mb-1">Active Penalty:</h6>
             <p class="mb-0 text-warning small penalty-text-content"></p>
             {# JS adds clear button here if needed #}
        </div>
      </div>
      {# Footer where JS adds Join/Leave/Login button #}
      <div class="card-footer text-muted text-center join-leave-footer"></div>
    </div>
  </div>
</template>
{% endif %}
{# --- End Template --- #}

{% endblock %}


{% block scripts %}
{{ super() }} {# Include scripts from base.html #}

{# --- Conditionally Load Penalty-Related Scripts --- #}
{% set might_have_penalties = (shared_challenge and shared_challenge.penalty_info) or is_local %}
{% if might_have_penalties %}
  <script src="{{ url_for('static', filename='js/libs/Winwheel.min.js') }}"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenMax.min.js"></script>
  <script type="module" src="{{ url_for('static', filename='js/penalties/penaltyLocalStorageUtils.js') }}"></script>
{% endif %}

{# --- Core Challenge View Modules --- #}
<script type="module" src="{{ url_for('static', filename='js/utils/helpers.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/utils/api.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/challenge/local_challenge_storage.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/challenge/challenge_ui.js') }}"></script>

{# --- Conditionally Load Penalty Logic Module --- #}
{% if might_have_penalties %}
  <script type="module" src="{{ url_for('static', filename='js/challenge/challenge_penalty.js') }}"></script>
{% endif %}

{# *** ADDED: Load the Timer Module *** #}
<script type="module" src="{{ url_for('static', filename='js/challenge/challenge_timer.js') }}"></script>

{# --- Main View Orchestrator Module (Loads Last) --- #}
<script type="module" src="{{ url_for('static', filename='js/challenge/challenge_view.js') }}"></script>

{% endblock %}
