{% extends "base.html" %}

{# --- Corrected Title Block --- #}
{% block title %}
{% if shared_challenge %}
Challenge: {{ shared_challenge.name or shared_challenge.public_id }}
{% else %}
Challenge Not Found
{% endif %}
{% endblock %}

{% block head %}
{# --- Link to External Stylesheet --- #}
<link rel="stylesheet" href="{{ url_for('static', filename='css/challenge_view.css') }}">
{% endblock %}


{% block content %}
<div class="container mt-4">

  {# --- Main Content Area --- #}
  {% if shared_challenge %}

  {# Div to store JSON data for JS #}
  <div id="challengeDataStore" style="display: none;" aria-hidden="true"
    data-challenge='{{ shared_challenge.challenge_data | tojson }}'>
  </div>

  {# --- Challenge Header --- #}
  <div class="mb-4 p-3 rounded challenge-header">
    <h1 class="display-4">{{ shared_challenge.name or "Unnamed Shared Challenge" }}</h1>
    <p class="lead">
      Public ID: <code class="user-select-all">{{ shared_challenge.public_id }}</code>
    </p>
    <p><small class="text-muted">Created by: {{ shared_challenge.creator.username if shared_challenge.creator else
        "Unknown" }} | Max Groups: <span id="maxGroupsInfo">{{ shared_challenge.max_groups }}</span></small></p>
    <hr>
    <p class="mb-0">Share this page's URL with others to join the challenge!</p>
  </div>


  {# --- Core Challenge Details (Static Display) --- #}
  <div class="mb-4 card bg-dark text-light">
    <div class="card-header">
      <h3 class="mb-0">Challenge Rules</h3>
    </div>
    <div class="card-body">
      {% set c = shared_challenge.challenge_data %}
      {% include 'challenge/_challenge_details.html' ignore missing %}
    </div>
  </div>


  {# --- Penalty Section (Conditional) --- #}
  {% if shared_challenge.penalty_info %}
  <div class="mb-4 card bg-secondary text-light">
    <div class="card-header">
      <h3 class="mb-0">Penalties</h3>
    </div>
    <div class="card-body">
      {# These variables are already set correctly here #}
      {% set p_info = shared_challenge.penalty_info %}
      {% set players = p_info.get('player_names', []) %}
      {% set penalty_tab_id = p_info.get('tab_id') %}
      {% set challenge_index = 'shared' %}

      {# Include without 'with' - it inherits players, penalty_tab_id, challenge_index from scope #}
      {% include 'challenge/_challenge_penalty_section.html' ignore missing %}

    </div>
  </div>
  {% endif %}


  {# --- Group Management & Display --- #}
  <hr class="my-4 border-secondary">
  <h2 class="mb-3 text-light">Groups & Progress</h2>

  {# --- Create New Group Form --- #}
  <div class="mb-4 card bg-dark border-secondary text-light">
    <div class="card-body">
      <h4 class="card-title text-warning">Create a New Group</h4>
      <form id="addGroupForm" class="form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="form-row align-items-center">
          <div class="col-sm-8 col-md-9 mb-2 mb-sm-0">
            <label for="groupNameInput" class="sr-only">Group Name</label>
            <input type="text" class="form-control form-control-lg bg-secondary text-light border-secondary"
              id="groupNameInput" name="group_name" placeholder="Enter new group name" required maxlength="80">
          </div>
          <div class="col-sm-4 col-md-3">
            <button type="submit" id="addGroupBtn" class="btn btn-success btn-lg btn-block">
              <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              <span>Create Group</span>
            </button>
          </div>
        </div>
        <small id="groupLimitInfo" class="form-text text-muted mt-2">
          Groups: <span id="currentGroupCount">{{ shared_challenge.groups | length }}</span> / {{
          shared_challenge.max_groups }}
        </small>
      </form>
      <div id="addGroupError" class="text-danger mt-2 font-weight-bold" style="display: none;"></div>
    </div>
  </div>

  {# --- Display Existing Groups --- #}
  <div id="groupsContainer" class="row">
    {# Loop through groups passed from backend #}
    {% if shared_challenge.groups %}
    {% for group in shared_challenge.groups %}
    <div class="col-lg-4 col-md-6 mb-4 group-card-wrapper" data-group-id="{{ group.id }}">
      <div class="card group-card">
        <div class="card-body">
          <h5 class="card-title">{{ group.group_name | escape }}</h5>
          {# Set variables needed by the included partial #}
          {% set challenge = shared_challenge %}
          {% set is_member = current_user.is_authenticated and group.id == user_joined_group_id %}
          {# Include partial to display progress checkboxes (inherits scope) #}
          {% include 'challenge/_challenge_group_progress.html' ignore missing %}
        </div>
        <div class="card-footer text-muted text-center">
          {# Join/Leave buttons rendered based on member status #}
          {% if current_user.is_authenticated %}
          {% if group.id == user_joined_group_id %}
          <button class="btn btn-sm btn-danger leave-group-btn" data-group-id="{{ group.id }}">
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span><span>Leave
              Group</span>
          </button>
          {# Check group membership count (assuming 1 member max) #}
          {% elif group.members | length >= 1 and group.id != user_joined_group_id %}
          <button class="btn btn-sm btn-outline-secondary" disabled>
            <span>{% if user_joined_group_id is not none %}Joined Other{% else %}Full{% endif %}</span>
          </button>
          {% elif user_joined_group_id is not none and group.id != user_joined_group_id %}
          <button class="btn btn-sm btn-outline-secondary" disabled><span>Joined Other</span></button>
          {% else %}
          <button class="btn btn-sm btn-success join-group-btn" data-group-id="{{ group.id }}">
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span><span>Join
              Group</span>
          </button>
          {% endif %}
          {% else %}
          <a href="{{ url_for('auth.login', next=request.url) }}" class="btn btn-sm btn-outline-primary">Log in to
            Join</a>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
    {% endif %}
    <div id="noGroupsMessageContainer" class="col-12 {% if shared_challenge.groups %}d-none{% endif %}">
      <p class="text-muted text-center py-5">No groups currently exist. Use the form above to create one!</p>
    </div>
  </div> {# End groupsContainer row #}

  {% else %}
  {# Message if challenge not found #}
  <div class="alert alert-danger" role="alert"> /* ... */ </div>
  {% endif %} {# End if shared_challenge #}

</div> {# End container #}

{# Template for new group cards - Ensure footer exists #}
<template id="groupCardTemplate">
  <div class="col-lg-4 col-md-6 mb-4 group-card-wrapper" data-group-id="">
    <div class="card group-card">
      <div class="card-body">
        <h5 class="card-title"></h5>
        <div class="group-progress-container">
          <p class="text-muted small">Loading progress...</p>
        </div>
      </div>
      <div class="card-footer text-muted text-center">
        {# Button added by JS #}
      </div>
    </div>
  </div>
</template>

{% endblock %}


{% block scripts %}
{# --- Include JS Libraries IF Penalty feature is used --- #}
{# {% if shared_challenge and shared_challenge.penalty_info %} #}
{# <script src="{{ url_for('static', filename='js/libs/Winwheel.min.js') }}"></script> #}
{# <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenMax.min.js"></script> #}
{# {% endif %} #}

{# --- Pass ALL Data via Data Attributes --- #}
{% if shared_challenge %}
{# Single element holding all server-rendered data for JS #}
<div id="challengeData" style="display: none;" aria-hidden="true"
    data-public-id="{{ shared_challenge.public_id }}"
    data-max-groups="{{ shared_challenge.max_groups }}"
    data-initial-group-count="{{ shared_challenge.groups | length }}"
    data-user-joined-group-id="{{ user_joined_group_id | tojson }}"
    data-csrf-token="{{ csrf_token() }}"
    data-add-group-url="{{ url_for('challenge_api.add_group_to_challenge', public_id=shared_challenge.public_id) }}"
    data-update-progress-url-base="{{ url_for('challenge_api.update_group_progress', public_id=shared_challenge.public_id, group_id=0) | replace('/0/progress', '') }}"
    data-join-leave-url-base="{{ url_for('challenge_api.join_group', group_id=0) | replace('/groups/0/join', '/groups') }}"
></div>
<script id="challengeJsonData" type="application/json">
  {{ shared_challenge.challenge_data | tojson | safe }} {# Use safe here for raw JSON content #}
</script>
{% endif %}

{# --- Load JS Modules --- #}
{# Load penalty JS IF Penalty feature is used #}
{# {% if shared_challenge and shared_challenge.penalty_info %} #}
{# <script type="module" src="{{ url_for('static', filename='js/challenge/challenge_penalty.js') }}"></script> #}
{# {% endif %} #}

{# Load Main JS Module for this page #}
<script type="module" src="{{ url_for('static', filename='js/challenge/challenge_view.js') }}"></script>

{% endblock %}